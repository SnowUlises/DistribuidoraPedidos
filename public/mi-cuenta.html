<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - Distribuidora Funaz</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: { 400: '#a3e635', 500: '#84cc16', 600: '#65a30d' } } }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1f2937; padding-bottom: 80px; }
        .mono-num { font-family: 'JetBrains Mono', monospace; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div class="flex-1 max-w-5xl mx-auto w-full p-4 md:p-8">
        
        <header class="flex items-center justify-between mb-8">
            <a href="index.html" class="flex items-center gap-2 text-gray-600 hover:text-brand-600 font-bold text-sm bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 shadow-sm transition-colors">
                â¬… Ir a la Tienda
            </a>
            <h1 class="text-xl font-bold tracking-tight text-gray-900">Mi Perfil</h1>
            <div class="w-8"></div>
        </header>

        <div id="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
            <div class="w-10 h-10 border-4 border-brand-500 border-t-transparent rounded-full animate-spin mb-3"></div>
            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Cargando perfil...</span>
        </div>

        <div id="main-content" class="hidden">
            
            <div class="bg-gray-900 text-white rounded-2xl p-6 mb-8 shadow-xl shadow-gray-200 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-24 bg-brand-500 rounded-full blur-3xl opacity-20 -mr-10 -mt-10"></div>
                <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div id="user-initials" class="w-12 h-12 rounded-full bg-brand-500 text-brand-900 flex items-center justify-center font-bold text-xl shadow-lg">
                            --
                        </div>
                        <div>
                            <h2 id="user-name" class="text-lg font-bold leading-tight">Cargando...</h2>
                            <p id="user-email" class="text-xs text-gray-400">...</p>
                        </div>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <a href="deudas.html" class="flex-1 md:flex-none bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors border border-white/10">
                            Estado de Cuenta
                        </a>
                        <button onclick="logout()" class="flex-1 md:flex-none bg-red-500/20 hover:bg-red-500/30 text-red-200 px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors border border-red-500/20">
                            Salir
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex border-b border-gray-200 mb-6">
                <button id="tab-pedidos" class="pb-3 px-4 text-sm font-bold border-b-2 transition-colors border-brand-500 text-brand-600" onclick="cambiarTab('pedidos')">
                    Mis Pedidos
                </button>
                <button id="tab-historial" class="pb-3 px-4 text-sm font-bold border-b-2 transition-colors border-transparent text-gray-400 hover:text-gray-600" onclick="cambiarTab('historial')">
                    Historial
                </button>
            </div>

            <div id="empty-state" class="hidden text-center py-12 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                <div class="text-4xl mb-3">ðŸ“¦</div>
                <p class="text-sm text-gray-500 font-medium">No hay registros aquÃ­.</p>
                <a href="index.html" class="text-xs text-brand-600 font-bold hover:underline mt-2 inline-block">Realizar un pedido</a>
            </div>

            <div id="orders-list" class="space-y-4">
                </div>

        </div>
    </div>

    <script>
        // CONFIGURACIÃ“N
        const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscm95Y3hpZndlenRoZG9ta255Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjI3MjM0MiwiZXhwIjoyMDcxODQ4MzQyfQ.s7vfcg-sqZw-VxXUnOCyroi7oTyzfx0i4siNeDOW6lE';
        const API_BASE = 'https://distribuidorafunaz-a2o6.onrender.com/api';

        // VARIABLES GLOBALES
        let currentUser = null;
        let todosLosPedidos = [];
        let productosCache = [];
        let tabActual = 'pedidos'; // 'pedidos' o 'historial'

        // INICIO
        document.addEventListener('DOMContentLoaded', async () => {
            await iniciarApp();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        async function iniciarApp() {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            try {
                // 1. Auth
                const { data } = await supabase.auth.getSession();
                if (!data || !data.session) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = data.session.user;
                renderizarPerfil();

                // 2. Cargar Datos en paralelo
                await Promise.all([
                    cargarPedidos(currentUser.id),
                    cargarProductos()
                ]);

                // 3. Mostrar UI
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                renderizarLista();

            } catch (e) {
                console.error("Error crÃ­tico:", e);
                alert("Error al cargar perfil. Revisa tu conexiÃ³n.");
            }
        }

        function renderizarPerfil() {
            const meta = currentUser.user_metadata || {};
            const nombre = meta.full_name || meta.name || currentUser.email.split('@')[0];
            const email = currentUser.email;
            const iniciales = nombre.substring(0, 2).toUpperCase();

            document.getElementById('user-name').textContent = nombre;
            document.getElementById('user-email').textContent = email;
            document.getElementById('user-initials').textContent = iniciales;
        }

        async function cargarPedidos(uid) {
            try {
                const res = await fetch(`${API_BASE}/mis-pedidos?uid=${uid}`);
                if (res.ok) {
                    todosLosPedidos = await res.json();
                }
            } catch (e) { console.error("Error pedidos", e); }
        }

        async function cargarProductos() {
            try {
                const res = await fetch(`${API_BASE}/productos`);
                if (res.ok) {
                    productosCache = await res.json();
                }
            } catch (e) { console.error("Error productos", e); }
        }

        function cambiarTab(nuevoTab) {
            tabActual = nuevoTab;
            
            // Actualizar estilos botones
            const btnP = document.getElementById('tab-pedidos');
            const btnH = document.getElementById('tab-historial');
            
            if (tabActual === 'pedidos') {
                btnP.className = "pb-3 px-4 text-sm font-bold border-b-2 transition-colors border-brand-500 text-brand-600";
                btnH.className = "pb-3 px-4 text-sm font-bold border-b-2 transition-colors border-transparent text-gray-400 hover:text-gray-600";
            } else {
                btnP.className = "pb-3 px-4 text-sm font-bold border-b-2 transition-colors border-transparent text-gray-400 hover:text-gray-600";
                btnH.className = "pb-3 px-4 text-sm font-bold border-b-2 transition-colors border-brand-500 text-brand-600";
            }

            renderizarLista();
        }

        function renderizarLista() {
            const contenedor = document.getElementById('orders-list');
            contenedor.innerHTML = ''; // Limpiar

            // Filtrar
            const listaFiltrada = todosLosPedidos.filter(p => {
                const estado = (p.estado || 'Pendiente').toLowerCase();
                if (tabActual === 'pedidos') {
                    return estado === 'pendiente' || estado === 'en proceso' || estado === 'confirmado';
                } else {
                    return estado === 'completado' || estado === 'entregado' || estado === 'cancelado';
                }
            });

            // Estado vacÃ­o
            if (listaFiltrada.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            // Generar HTML
            listaFiltrada.forEach(pedido => {
                const estadoClass = getEstadoClass(pedido.estado);
                const fecha = formatDate(pedido.fecha);
                const total = formatMoney(pedido.total);
                const itemsCount = (pedido.items || []).length;
                const negocio = pedido.negocio || 'Pedido Personal';
                
                // Generar HTML de productos (oculto por defecto)
                let productosHTML = '';
                (pedido.items || []).forEach(prod => {
                    const nombre = getNombreProducto(prod);
                    const subtotal = formatMoney(prod.precio * prod.cantidad);
                    productosHTML += `
                        <div class="flex justify-between text-sm mb-1">
                            <div class="text-gray-600 truncate pr-4">
                                <span class="font-bold text-gray-900">x${prod.cantidad}</span> ${nombre}
                            </div>
                            <div class="text-gray-900 font-medium mono-num">${subtotal}</div>
                        </div>
                    `;
                });

                const cardHTML = `
                    <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${estadoClass}">
                                        ${pedido.estado || 'Pendiente'}
                                    </span>
                                    <span class="text-xs text-gray-400">${fecha}</span>
                                </div>
                                <div class="text-sm font-bold text-gray-800">${negocio}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-gray-900 mono-num">${total}</div>
                                <div class="text-[10px] text-gray-400">${itemsCount} productos</div>
                            </div>
                        </div>

                        <button onclick="toggleDetalle('${pedido.id}')" class="w-full text-center py-2 bg-gray-50 hover:bg-gray-100 rounded-lg text-xs font-bold text-gray-500 transition-colors">
                            Ver / Ocultar Productos
                        </button>

                        <div id="detalle-${pedido.id}" class="hidden mt-3 pt-3 border-t border-gray-100">
                            ${productosHTML}
                        </div>
                    </div>
                `;
                contenedor.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        // --- UTILIDADES ---

        function toggleDetalle(id) {
            const el = document.getElementById(`detalle-${id}`);
            if (el) el.classList.toggle('hidden');
        }

        function getNombreProducto(item) {
            if (item.nombre) return item.nombre;
            const prod = productosCache.find(p => String(p.id) === String(item.id));
            return prod ? prod.nombre : 'Producto #' + item.id;
        }

        function getEstadoClass(estado) {
            const st = (estado || 'pendiente').toLowerCase();
            if (st === 'pendiente') return 'bg-yellow-100 text-yellow-700';
            if (st === 'confirmado' || st === 'en proceso') return 'bg-blue-100 text-blue-700';
            if (st === 'entregado' || st === 'completado') return 'bg-green-100 text-green-700';
            if (st === 'cancelado') return 'bg-red-100 text-red-700';
            return 'bg-gray-100 text-gray-600';
        }

        function formatDate(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            return d.toLocaleDateString('es-AR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        function formatMoney(val) {
            return '$' + (Number(val) || 0).toLocaleString('es-AR', { minimumFractionDigits: 0 });
        }

        async function logout() {
            if (confirm("Â¿Cerrar sesiÃ³n?")) {
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
