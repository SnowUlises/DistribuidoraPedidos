<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Distribuidora Funaz</title>
  <style>
    :root {
      --primary-green: #2E7D32;
      --light-green: #4CAF50;
      --soft-green: #E8F5E9;
      --text-dark: #333;
      --bg-color: #fcfdfc;
      --white: #ffffff;
      --danger: #e57373;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif; 
      margin:0; 
      background:var(--bg-color); 
      color:var(--text-dark); 
      padding-bottom: 80px; /* Espacio para el toast en movil */
    }

    /* HEADER */
    header {
      background: var(--primary-green);
      color: var(--white);
      padding: 0.8em 1.5em;
      display: flex;
      align-items: center;
      gap: 1em;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header img { height:35px; width:35px; border-radius:50%; border: 2px solid rgba(255,255,255,0.3); }
    header h1 { margin:0; font-size:1.2em; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    #btnCarrito {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      border: none;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #btnCarrito.bump { animation: pop 0.3s ease; background: var(--white); color: var(--primary-green); }
    @keyframes pop { 50% { transform: scale(1.2); } }

    /* LAYOUT */
    .container { display:flex; min-height: 100vh; }
    
    /* ASIDE - CATEGOR√çAS */
    aside { 
      width: 220px; 
      background: var(--white); 
      padding: 1.5em; 
      border-right: 1px solid #eee; 
      flex-shrink: 0;
    }
    aside h2 { font-size:1em; margin-bottom:1em; color: var(--primary-green); text-transform: uppercase; letter-spacing: 1px; }
    aside ul { list-style:none; padding:0; margin: 0; }
    aside li { 
      margin: 0.3em 0; 
      cursor: pointer; 
      padding: 0.8em 1em; 
      border-radius: 8px; 
      color: #555;
      font-size: 0.95em;
      transition: all 0.2s;
    }
    aside li:hover { background: var(--soft-green); color: var(--primary-green); }
    aside li.active { background: var(--soft-green); color: var(--primary-green); font-weight: 700; border-left: 3px solid var(--primary-green); }

    /* MAIN CONTENT */
    main { flex:1; padding: 2em; max-width: 100%; }

    /* TOOLBAR (Buscar/Ordenar) */
    .toolbar-container {
      background: var(--white);
      padding: 1em;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      margin-bottom: 1.5em;
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: space-between;
      align-items: center;
    }
    
    .ordenar, .cantidad-por-pagina { display: flex; align-items: center; gap: 0.5em; }
    
    select, input[type="search"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.9em;
      outline: none;
    }
    input[type="search"] { width: 200px; }
    select:focus, input:focus { border-color: var(--light-green); }

    /* PRODUCTOS GRID */
    .productos {
      display: grid;
      gap: 15px;
      grid-template-columns: repeat(var(--cols, 3), 1fr);
    }

    .producto {
      background: var(--white);
      border-radius: 12px;
      border: 1px solid #f0f0f0;
      padding: 1em;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .producto:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    
    .producto img {
      width: 100px; height: 100px;
      border-radius: 10px;
      object-fit: cover;
      margin-bottom: 0.8em;
      background: #f9f9f9;
    }
    
    .producto h3 { 
      margin: 0.5em 0; 
      font-size: 0.95em; 
      text-align: center; 
      line-height: 1.3;
      height: 2.6em; /* Limita altura titulo */
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .producto .precio {
      font-size: 1.1em;
      color: var(--primary-green);
      font-weight: bold;
      margin-bottom: 0.8em;
    }

    .btn-carrito {
      background: var(--light-green);
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      width: 100%;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-carrito:active { transform: scale(0.96); }
    /* Clase para feedback visual al hacer click */
    .btn-carrito.agregado {
      background: var(--primary-green);
      position: relative;
    }
    .btn-carrito.agregado::after {
      content: "‚úì";
      margin-left: 5px;
    }

    .sin-stock {
      margin-top: 8px;
      color: var(--danger);
      font-weight: bold;
      text-align: center;
      font-size: 0.9em;
      background: #ffebee;
      padding: 5px;
      border-radius: 4px;
      width: 100%;
    }

    /* PAGINACION */
    .paginacion { display: flex; justify-content: center; gap: 15px; margin-top: 2em; }
    .paginacion button {
      background: var(--white); border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px;
      color: var(--text-dark); font-weight: 600; cursor: pointer;
    }
    
    /* TOAST (Mensaje Flotante) - Mejorado para movil */
    #mensajeCarrito {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #333;
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-weight: 500;
      font-size: 0.95em;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: max-content;
      max-width: 90%;
      text-align: center;
    }
    #mensajeCarrito.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* CARRITO MODAL */
    #carritoContainer {
      position: fixed; top: 70px; right: 20px; width: 320px; max-height: 80vh;
      background: #fff; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
      overflow-y: auto; display: none; z-index: 1500; padding: 15px; border: 1px solid #eee;
    }

    /* --- RESPONSIVE MOBILE OPTIMIZATION --- */
    @media (max-width: 768px) {
      /* Reestructurar Contenedor */
      .container { flex-direction: column; }
      
      /* Header m√°s compacto */
      header { padding: 0.8em 1em; }
      header h1 { font-size: 1.1em; }

      /* Aside se convierte en Barra de Categor√≠as Horizontal (Scrollable) */
      aside {
        width: 100%;
        padding: 10px 15px;
        border-right: none;
        border-bottom: 1px solid #eee;
        overflow-x: auto;
        white-space: nowrap;
        background: var(--white);
        position: sticky;
        top: 60px; /* Debajo del header */
        z-index: 900;
        -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
      }
      /* Ocultar barra de scroll pero mantener funcionalidad */
      aside::-webkit-scrollbar { display: none; }
      
      aside h2 { display: none; } /* Ocultar titulo 'Categorias' en movil */
      
      aside ul { display: flex; gap: 10px; }
      aside li {
        margin: 0;
        padding: 6px 16px;
        background: #f5f5f5;
        border-radius: 20px;
        font-size: 0.9em;
        border: 1px solid transparent;
      }
      aside li.active {
        background: var(--soft-green);
        border: 1px solid var(--primary-green);
        border-left: 1px solid var(--primary-green); /* Reset del estilo desktop */
      }

      /* Main y Toolbar */
      main { padding: 15px; }
      .toolbar-container { flex-direction: column; align-items: stretch; gap: 10px; }
      .ordenar, .cantidad-por-pagina { justify-content: space-between; }
      input[type="search"] { width: 100%; margin-left: 0 !important; margin-top: 5px; }
      
      /* Grid Forzado a 2 Columnas en M√≥vil */
      .productos {
        grid-template-columns: repeat(2, 1fr) !important; 
        gap: 10px;
      }
      
      .producto { padding: 10px; }
      .producto img { width: 80px; height: 80px; }
      .producto h3 { font-size: 0.85em; }
      
      /* Botones m√°s grandes para dedos */
      .btn-carrito { padding: 12px 5px; font-size: 0.9em; }

      /* Carrito en pantalla completa o flotante centrado */
      #carritoContainer {
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 90%; max-height: 70vh; right: auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
        <img id="logoImg" src="" alt="Logo" />
        <h1>Distribuidora Funaz</h1>
    </div>
    <button id="btnCarrito">üõí <span>(0)</span></button>
  </header>

  <div id="carritoContainer">
    <h3 style="text-align:center; color:var(--primary-green); margin-top:0;">Tu Carrito</h3>
    <div id="itemsCarrito"></div>
    <div style="margin-top:15px; display:flex; gap:10px; justify-content:center;">
      <button onclick="vaciarCarrito()" style="background:#e57373; padding:8px 12px; border:none; color:#fff; border-radius:6px; flex:1;">Vaciar</button>
      <button onclick="verCarrito()" style="background:var(--primary-green); padding:8px 12px; border:none; color:#fff; border-radius:6px; font-weight:bold; flex:1;">Ver Detalle</button>
    </div>
    <button onclick="toggleCarrito()" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.2em; color:#999;">‚úï</button>
  </div>

  <div class="container">
    <aside>
      <h2>Categor√≠as</h2>
      <ul id="listaCategorias">
        <li class="active" onclick="filtrarCategoria('Todos', this)">Todos</li>
        <li onclick="filtrarCategoria('ALIMENTOS', this)">Alimentos</li>
        <li onclick="filtrarCategoria('BEBIDAS', this)">Bebidas</li>
        <li onclick="filtrarCategoria('ACCESORIOS', this)">Accesorios</li>
        <li onclick="filtrarCategoria('LIMPIEZA', this)">Limpieza</li>
        <li onclick="filtrarCategoria('PERFUMERIA', this)">Perfumeria</li>
        <li onclick="filtrarCategoria('ANALGESICOS', this)">Analgesicos</li>
        <li onclick="filtrarCategoria('ENCENDEDORES', this)">Encendedores</li>
        <li onclick="filtrarCategoria('CREMAS', this)">Cremas</li>
        <li onclick="filtrarCategoria('DESODORANTES', this)">Desodorantes</li>
        <li onclick="filtrarCategoria('GALLETAS Y GOLOSINAS', this)">Galletas</li>
        <li onclick="filtrarCategoria('JUGOS', this)">Jugos</li>
        <li onclick="filtrarCategoria('PAPELES Y BOLSAS', this)">Papeles</li>
        <li onclick="filtrarCategoria('PEGAMENTOS', this)">Pegamentos</li>
        <li onclick="filtrarCategoria('REPELENTES', this)">Repelentes</li>
        <li onclick="filtrarCategoria('SHAMPO Y ENJUAGUE', this)">Shampo</li>
        <li onclick="filtrarCategoria('TINTURAS NANTYR', this)">Tinturas</li>
      </ul>
    </aside>

    <main>
      <div class="toolbar-container">
        <div class="ordenar">
            <span>Ordenar:</span>
            <select id="orden" onchange="renderProductos()">
            <option value="nombre">Nombre</option>
            <option value="precioAsc">Precio ‚Üë</option>
            <option value="precioDesc">Precio ‚Üì</option>
            </select>
        </div>
        
        <div class="ordenar" style="flex-grow:1; justify-content:flex-end;">
            <input id="buscador" type="search" placeholder="üîç Buscar producto..." />
        </div>

        <div class="cantidad-por-pagina">
            <span>Ver:</span>
            <select id="cantidadPagina" onchange="cambiarCantidadPagina()">
            <option value="4">4</option>
            <option value="9" selected>9</option>
            <option value="16">16</option>
            <option value="25">25</option>
            </select>
        </div>
      </div>

      <div class="productos"></div>
      
      <div class="paginacion">
        <button onclick="paginaAnterior()" id="btnPrev">‚Üê Anterior</button>
        <span id="infoPagina" style="align-self:center;"></span>
        <button onclick="paginaSiguiente()" id="btnNext">Siguiente ‚Üí</button>
      </div>
    </main>
  </div>

  <div id="mensajeCarrito">Producto Agregado</div>

  <footer>
    <div class="contacto">Informaci√≥n de contacto</div>
    <div class="derechos">Distribuidora Funaz, ¬© 2025</div>
  </footer>

<script>
let productos = [];
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
let categoriaSeleccionada = 'Todos';
let paginaActual = 1;
let cantidadPorPagina = 9;
let terminoBusqueda = '';

function toggleCarrito() {
  const c = document.getElementById('carritoContainer');
  c.style.display = c.style.display === 'block' ? 'none' : 'block';
  renderCarrito();
}

function verCarrito() {
  if (carrito.length === 0) {
    alert('El carrito est√° vac√≠o.');
  } else {
    location.href = 'carrito.html';
  }
}

document.getElementById('btnCarrito').addEventListener('click', toggleCarrito);

async function cargarProductos() {
  try {
    const res = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/productos');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    productos = await res.json();
    console.log('Loaded products:', productos.length);
    cambiarCantidadPagina();
  } catch (err) {
    console.error('Error cargando productos:', err);
    alert('Error de conexi√≥n. Intente recargar.');
  }
}

function filtrarCategoria(categoria, elemento) {
  categoriaSeleccionada = categoria;
  document.querySelectorAll('#listaCategorias li').forEach(li => li.classList.remove('active'));
  elemento.classList.add('active');
  
  // En movil, scroll automatico para centrar la categoria seleccionada
  if(window.innerWidth < 768) {
    elemento.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }

  paginaActual = 1;
  renderProductos();
}

function cambiarCantidadPagina() {
  const sel = document.getElementById('cantidadPagina');
  cantidadPorPagina = parseInt(sel.value);
  paginaActual = 1;
  const cols = Math.sqrt(cantidadPorPagina);
  document.querySelector('.productos').style.setProperty('--cols', cols);
  renderProductos();
}

function getImageUrl(fileName) {
  if (!fileName) return '';
  const cleanFileName = fileName.trim().replace(/^imagenes\//, '');
  return `https://slroycxifwezthdomkny.supabase.co/storage/v1/object/public/imagenes/${cleanFileName}`;
}

function renderProductos() {
  const cont = document.querySelector('.productos');
  cont.innerHTML = '';
  let filtrados = productos;
  if (categoriaSeleccionada !== 'Todos') {
    filtrados = productos.filter(p => p.categoria === categoriaSeleccionada);
  }
  const orden = document.getElementById('orden').value;
  if (orden === 'nombre') {
    filtrados.sort((a,b) => a.nombre.localeCompare(b.nombre));
  } else if (orden === 'precioAsc') {
    filtrados.sort((a,b) => a.precio - b.precio);
  } else if (orden === 'precioDesc') {
    filtrados.sort((a,b) => b.precio - a.precio);
  }
  if (terminoBusqueda) {
    filtrados = filtrados.filter(p => {
      const nombre = (p.nombre || '').toString().toLowerCase();
      const desc = (p.descripcion || '').toString().toLowerCase();
      return nombre.includes(terminoBusqueda) || desc.includes(terminoBusqueda);
    });
  }
  const totalPaginas = Math.ceil(filtrados.length / cantidadPorPagina);
  if(paginaActual > totalPaginas) paginaActual = totalPaginas || 1;
  const inicio = (paginaActual -1) * cantidadPorPagina;
  const fin = inicio + cantidadPorPagina;
  const productosPagina = filtrados.slice(inicio, fin);
  
  productosPagina.forEach(p => {
    const div = document.createElement('div');
    div.className = 'producto';
    let accionHTML = '';
    
    if (p.stock <= -99) {
      accionHTML = '<div class="sin-stock">AGOTADO</div>';
    } else {
      // Pasamos 'this' para poder animar el boton
      accionHTML = `<button class="btn-carrito" onclick="agregarAlCarrito(${p.id}, 1, false, this)">Agregar +</button>`;
    }
    
    const img = document.createElement('img');
    img.alt = p.nombre;
    img.src = getImageUrl('placeholder.png');
    if (p.imagen) {
      const publicUrl = getImageUrl(p.imagen);
      if (publicUrl) {
        const realImg = new Image();
        realImg.src = publicUrl;
        realImg.onload = () => { img.src = publicUrl; };
        realImg.onerror = () => { img.src = getImageUrl('placeholder.png'); };
      }
    }
    
    div.innerHTML = `
      <h3>${p.nombre}</h3>
      <div class="precio">$${(p.precio * 1.10).toFixed(2)}</div>
      ${accionHTML}
    `;
    div.insertBefore(img, div.firstChild);
    
    // Click en la tarjeta lleva al detalle, excepto si clickeas el boton
    div.onclick = (event) => {
      if (!event.target.classList.contains('btn-carrito')) {
        window.location.href = `producto.html?id=${p.id}`;
      }
    };
    cont.appendChild(div);
  });
  
  document.getElementById('infoPagina').textContent = `${paginaActual} / ${totalPaginas || 1}`;
  document.getElementById('btnPrev').disabled = paginaActual === 1;
  document.getElementById('btnNext').disabled = paginaActual === totalPaginas || totalPaginas === 0;
}

function paginaAnterior() {
  if (paginaActual > 1) {
    paginaActual--;
    renderProductos();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}
function paginaSiguiente() {
  const totalPaginas = Math.ceil((categoriaSeleccionada === 'Todos' ? productos.length : productos.filter(p => p.categoria === categoriaSeleccionada).length) / cantidadPorPagina);
  if (paginaActual < totalPaginas) {
    paginaActual++;
    renderProductos();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

// Modificado para aceptar el elemento boton (btnElement) para animaciones
function agregarAlCarrito(id, cantidad = 1, silent = false, btnElement = null) {
  const producto = productos.find(p => String(p.id) === String(id));

  if (!producto) {
    console.error("Producto no encontrado ID:", id);
    return;
  }

  if (producto.stock <= -99) {
    mostrarMensaje('Producto sin stock.', true);
    return;
  }
  
  const item = carrito.find(i => i.id === id);
  if (item) item.cantidad += cantidad;
  else carrito.push({ id, cantidad });
  
  localStorage.setItem('carrito', JSON.stringify(carrito));
  
  // Feedback Visual (Animaciones)
  if (btnElement) {
    const originalText = btnElement.innerText;
    btnElement.innerText = "¬°Agregado!";
    btnElement.classList.add('agregado');
    
    // VIBRACI√ìN PARA CELULAR (Haptic Feedback)
    if (navigator.vibrate) navigator.vibrate(50);

    setTimeout(() => {
        btnElement.innerText = originalText;
        btnElement.classList.remove('agregado');
    }, 1000);
  }
  
  const totalItems = carrito.reduce((acc, i) => acc + i.cantidad, 0);
  actualizarContadorCarrito();
  
  // Animacion en el icono del carrito header
  const btnHeader = document.getElementById('btnCarrito');
  btnHeader.classList.add('bump');
  setTimeout(() => btnHeader.classList.remove('bump'), 300);

  if (!silent) {
    mostrarMensaje(`+ ${producto.nombre} agregado`);
  }
  renderCarrito();
}

function actualizarContadorCarrito() {
  const total = carrito.reduce((acc, i) => acc + i.cantidad, 0);
  document.querySelector('#btnCarrito span').textContent = `(${total})`;
}

function renderCarrito() {
  const cont = document.getElementById('itemsCarrito');
  cont.innerHTML = '';
  if(carrito.length === 0){
    cont.innerHTML = '<p style="text-align:center; color:#888;">El carrito est√° vac√≠o.</p>';
    return;
  }
  carrito.forEach(item => {
    const prod = productos.find(p => String(p.id) === String(item.id));
    if (!prod) return;
    const div = document.createElement('div');
    div.className = 'item-carrito';
    div.style.cssText = "display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;";
    div.innerHTML = `
      <span>${prod.nombre} <b>x${item.cantidad}</b></span>
      <button onclick="eliminarDelCarrito(${item.id})" style="background:#ffcdd2; border:none; color:#c62828; width:25px; height:25px; border-radius:50%; font-weight:bold;">‚úï</button>
    `;
    cont.appendChild(div);
  });
}

function eliminarDelCarrito(id) {
  carrito = carrito.filter(i => i.id !== id);
  localStorage.setItem('carrito', JSON.stringify(carrito));
  actualizarContadorCarrito();
  renderCarrito();
}

function vaciarCarrito() {
  if(confirm('¬øVaciar todo el carrito?')){
    carrito = [];
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    renderCarrito();
    toggleCarrito();
  }
}

let mensajeTimeout = null;
function mostrarMensaje(texto, error = false) {
  const m = document.getElementById('mensajeCarrito');
  m.textContent = texto;
  m.style.background = error ? '#e53935' : '#333';
  m.classList.add('visible');
  if (mensajeTimeout) clearTimeout(mensajeTimeout);
  mensajeTimeout = setTimeout(() => {
    m.classList.remove('visible');
    mensajeTimeout = null;
  }, 2000);
}

function keepAlive() { console.log(""); }
setInterval(keepAlive, 30000);

actualizarContadorCarrito();
cargarProductos();

const buscadorInput = document.getElementById('buscador');
if (buscadorInput) {
  buscadorInput.addEventListener('input', (e) => {
    terminoBusqueda = e.target.value.trim().toLowerCase();
    paginaActual = 1;
    renderProductos();
  });
}
const logoImg = document.getElementById('logoImg');
logoImg.src = getImageUrl('logo.png');
</script>
</body>
</html>
