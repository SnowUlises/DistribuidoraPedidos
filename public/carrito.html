<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carrito de Compras — Distribuidora Funaz</title>
  <style>
    main { max-width: 900px; margin: auto; padding: 2em; display:flex; flex-direction:column; gap:1em; }
    h2 { text-align:center; margin-bottom:1em; color:#4a90e2; }
    .producto-carrito { display:flex; align-items:center; gap:1em; background:#fff; padding:1em; margin-bottom:1em; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); justify-content:space-between; }
    .producto-carrito img { width:100px; height:100px; object-fit:cover; border-radius:6px; }
    .producto-info { flex:1; }
    .producto-info p { margin:4px 0; }
    .controles-cantidad { display:flex; align-items:center; gap:0.5em; min-width:150px; }
    .controles-cantidad button { padding:6px 12px; border:none; background:#4a90e2; color:white; border-radius:6px; cursor:pointer; font-weight:bold; transition: background 0.2s; }
    .controles-cantidad button:hover { background:#357abd; }
    .controles-cantidad .cantidad-display { min-width:30px; text-align:center; font-weight:bold; }
    .controles-cantidad .btn-eliminar { background:#d9534f; margin-left:10px; }
    .controles-cantidad .btn-eliminar:hover { background:#c9302c; }
    #totalCarrito { text-align:right; font-weight:bold; font-size:1.2em; margin-top:1em; }
    #formOverlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:10000; }
    #formDatos { background:#f4f4f4; padding:2em; border-radius:10px; max-width:400px; width:90%; box-shadow:0 2px 12px rgba(0,0,0,0.3); position:relative; }
    #formDatos h3 { text-align:center; margin-bottom:1em; color:#4a90e2; }
    #formDatos input { display:block; width:100%; padding:8px; margin-bottom:1em; border:1px solid #ccc; border-radius:6px; }
    button.enviar { background:#4a90e2; border:none; color:white; padding:12px 20px; border-radius:6px; font-weight:bold; cursor:pointer; display:block; margin:0 auto; min-width:140px; }
    button.enviar:hover { background:#357ABD; }
    #btnCerrarFormulario { position:absolute; top:8px; right:8px; background:#d9534f; border:none; color:white; border-radius:50%; width:28px; height:28px; font-weight:bold; cursor:pointer; font-size:18px; line-height:22px; text-align:center; padding:0; }
    #btnCerrarFormulario:hover { background:#c9302c; }
    footer { text-align:center; color:#777; margin-top:2em }
    .mode-banner { text-align:center; padding:8px; border-radius:6px; font-weight:700; color:#fff; margin-bottom:0.6em; }
    .api-mode { background:#28a745; }
    .static-mode { background:#f39c12; }
    .download-link { display:block; margin-top:10px; text-align:center; }
  </style>
</head>
<body>
  <main>
    <div style="text-align: left;">
      <button onclick="location.href='index.html'" style="background:#4a90e2; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer;">Volver a la tienda</button>
    </div>
    <h2>Tu Carrito</h2>
    <div id="modeBanner" style="display:none" class="mode-banner"></div>

    <div id="listaCarrito"></div>
    <div id="totalCarrito"></div>
    <button id="btnMostrarFormulario" class="enviar">Enviar pedido</button>

    <div id="formOverlay">
      <div id="formDatos">
        <button type="button" id="btnCerrarFormulario" title="Cerrar">&times;</button>
        <h3>Completa tus datos</h3>
        <input type="text" id="nombre" placeholder="Nombre" required>
        <input type="text" id="apellido" placeholder="Apellido" required>
        <input type="tel" id="telefono" placeholder="Número de teléfono" required>
        <div id="sinStockAviso" style="color:#d9534f; margin-bottom:8px; text-align:center;"></div>
        <button class="enviar" id="confirmarEnvio">Enviar</button>

        <div id="postActions" style="margin-top:12px; text-align:center;"></div>
      </div>
    </div>
  </main>

  <footer>
    Distribuidora Funaz
  </footer>

<script>
/* Carrito corregido */
let productos = [];
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
const usuario = { user: localStorage.getItem('loggedUser') || 'invitado' };

const lista = document.getElementById('listaCarrito');
const totalCarritoElem = document.getElementById('totalCarrito');
const formOverlay = document.getElementById('formOverlay');
const btnMostrarFormulario = document.getElementById('btnMostrarFormulario');
const btnCerrarFormulario = document.getElementById('btnCerrarFormulario');
const btnConfirmar = document.getElementById('confirmarEnvio');
const postActions = document.getElementById('postActions');
const sinStockAviso = document.getElementById('sinStockAviso');

const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

async function cargarProductos() {
  try {
    const r = await fetch(`${apiBase}/productos`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    productos = await r.json();
    renderizarCarrito();
  } catch (err) {
    lista.innerHTML = '<p>Error cargando productos.</p>';
    console.error(err);
  }
}

function guardarCarrito() {
  localStorage.setItem('carrito', JSON.stringify(carrito));
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

function renderizarCarrito() {
  lista.innerHTML = '';
  postActions.innerHTML = '';
  sinStockAviso.textContent = '';

  if (carrito.length === 0) {
    lista.innerHTML = '<p>El carrito está vacío.</p>';
    btnMostrarFormulario.style.display = 'none';
    totalCarritoElem.textContent = '';
    ocultarFormulario();
    return;
  }
  btnMostrarFormulario.style.display = 'block';

  let total = 0;

  carrito.forEach((item, i) => {
    // comparación tolerante a tipo (string/number)
    const p = productos.find(prod => prod.id == item.id);
    if (!p) return;

    const div = document.createElement('div');
    div.className = 'producto-carrito';
    const precioPublico = (Number(p.precio || 0) * 1.10);
    const subtotal = precioPublico * item.cantidad;
    total += subtotal;

    div.innerHTML = `
      <img src="/imagenes/${p.id}.png" alt="${(p.nombre||'').replace(/"/g,'')}" onerror="this.onerror=null; this.src='/imagenes/placeholder.png'"/>
      <div class="producto-info">
        <p><strong>${p.nombre}</strong></p>
        <p>Precio unitario: ${formatMoney(precioPublico)}</p>
        <p>Subtotal: ${formatMoney(subtotal)}</p>
      </div>
      <div class="controles-cantidad">
        <button class="btn-reducir" title="Reducir cantidad">-</button>
        <span class="cantidad-display">${item.cantidad}</span>
        <button class="btn-aumentar" title="Aumentar cantidad">+</button>
        <button class="btn-eliminar" title="Eliminar producto">X</button>
      </div>
    `;

    // handlers
    const btnAumentar = div.querySelector('.btn-aumentar');
    const btnReducir = div.querySelector('.btn-reducir');
    const btnEliminar = div.querySelector('.btn-eliminar');
    const cantidadDisplay = div.querySelector('.cantidad-display');

    btnAumentar.addEventListener('click', (e) => {
      e.stopPropagation();
      const prod = productos.find(pr => pr.id == item.id);
      if (typeof prod?.stock === 'number' && item.cantidad + 1 > prod.stock) {
        alert(`No hay más stock disponible (${prod.stock}).`);
        return;
      }
      carrito[i].cantidad++;
      guardarCarrito();
      cantidadDisplay.textContent = carrito[i].cantidad;
      renderizarCarrito();
    });

    btnReducir.addEventListener('click', (e) => {
      e.stopPropagation();
      if (carrito[i].cantidad > 1) carrito[i].cantidad--;
      else carrito.splice(i, 1);
      guardarCarrito();
      renderizarCarrito();
    });

    btnEliminar.addEventListener('click', (e) => {
      e.stopPropagation();
      carrito.splice(i, 1);
      guardarCarrito();
      renderizarCarrito();
    });

    lista.appendChild(div);
  });

  totalCarritoElem.textContent = `Total: ${formatMoney(total)}`;
}

// Modal formulario
function mostrarFormulario() {
  // Limpiar inputs
  document.getElementById('nombre').value = '';
  document.getElementById('apellido').value = '';
  document.getElementById('telefono').value = '';

  formOverlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function ocultarFormulario() {
  formOverlay.style.display = 'none';
  document.body.style.overflow = '';
}

btnMostrarFormulario.addEventListener('click', mostrarFormulario);
btnCerrarFormulario.addEventListener('click', ocultarFormulario);
formOverlay.addEventListener('click', e => { if (e.target === formOverlay) ocultarFormulario(); });

btnConfirmar.addEventListener('click', async () => {
    const nombreInput = document.getElementById('nombre').value.trim();
    const apellidoInput = document.getElementById('apellido').value.trim();
    const telefono = document.getElementById('telefono').value.trim();
    if (!nombreInput || !apellidoInput || !telefono) {
        alert('Por favor, completa todos los campos.');
        return;
    }
    const nombre = capitalize(nombreInput);
    const apellido = capitalize(apellidoInput);
    const fullName = `${nombre} ${apellido}`;
    btnConfirmar.disabled = true;
    btnConfirmar.textContent = 'Procesando...';
    const nuevosCarrito = [];
    let total = 0;
    const productosClon = productos.map(p => ({...p}));
    for (const item of carrito) {
        const producto = productosClon.find(p => p.id == item.id);
        if (!producto) continue;
        const precioConRecargo = Number(producto.precio) * 1.10;
        nuevosCarrito.push({
            ...item,
            precio: precioConRecargo
        });
        total += item.cantidad * precioConRecargo;
    }
    if (nuevosCarrito.length === 0) {
        alert('No hay productos disponibles para pedir.');
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = 'Enviar';
        return;
    }
    try {
        const res = await fetch(`${apiBase}/Enviar-Peticion`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                nombre: fullName,
                telefono: telefono,
                items: nuevosCarrito,
                total: total
            })
        });
        if (!res.ok) {
            const txt = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
            throw new Error(txt.error || `HTTP ${res.status}`);
        }
        alert('Pedido enviado con éxito.');
        carrito = [];
        guardarCarrito();
        ocultarFormulario();
        renderizarCarrito();
        // Delay redirect to ensure alert is visible
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 1000);
    } catch (err) {
        console.error('Error enviando pedido:', err);
        alert(`No se pudo enviar el pedido: ${err.message}`);
    } finally {
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = 'Enviar';
    }
});
  
// helper
function formatMoney(n) {
  try { return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(n); }
  catch(e){ return '$' + Number(n).toFixed(2); }
}

// iniciar
(async function init(){
  await cargarProductos();
  // actualizar contador del header si existe botón
  const btnCarrito = document.getElementById('btnCarrito');
  if (btnCarrito) {
    const total = carrito.reduce((s,i) => s + i.cantidad, 0);
    btnCarrito.textContent = `Carrito (${total})`;
  }
})();
</script>

</body>
</html>

