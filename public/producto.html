<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detalle del producto - Distribuidora Funaz</title>
  <style>
    body { font-family:'Segoe UI',sans-serif; background:#f9f9f9; color:#333; margin:0; min-height:100vh; display:flex; flex-direction:column; }
    header { background:#4a90e2; color:#fff; padding:1em 2em; display:flex; align-items:center; gap:1em; position:relative; }
    header img { height:40px; width:40px; border-radius:50%; }
    header h1 { margin:0; font-size:1.8em; }
    header button { padding:8px 12px; border:none; border-radius:6px; background:#fff; color:#4a90e2; font-weight:bold; cursor:pointer; }
    header button:hover { background:#dceeff; }
    #btnCarritoHeader { margin-left:auto; background:#fff; color:#4a90e2; }
    #btnCarritoHeader:hover { background:#388E3C; color:#fff; }
    main { flex:1; display:flex; justify-content:center; align-items:center; padding:2em; }
    .producto { background:#fff; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1); max-width:600px; width:100%; display:flex; padding:1.5em; gap:1.5em; align-items:center; }
    .imagen-container { flex:0 0 200px; height:200px; }
    .imagen-container img { width:100%; height:100%; object-fit:contain; border-radius:12px; background:#eee; }
    .detalle { flex:1; display:flex; flex-direction:column; justify-content:space-between; height:200px; }
    .nombre { font-size:1.6em; font-weight:bold; margin-bottom:0.5em; }
    .precio { font-size:1.3em; color:#4a90e2; margin-bottom:0.5em; }
    .stock { font-weight:bold; margin-bottom:1em; display:flex; align-items:center; gap:0.5em; }
    .checkmark { width:20px; height:20px; border:2px solid #28a745; border-radius:4px; position:relative; background:white; display:inline-block; }
    .checkmark.checked::after { content:''; position:absolute; left:5px; top:1px; width:6px; height:12px; border:solid #28a745; border-width:0 2px 2px 0; transform:rotate(45deg); }
    .acciones { display:flex; align-items:center; gap:1em; }
    .acciones input[type=number]{ width:70px; padding:8px; font-size:1em; border-radius:6px; border:1px solid #ccc; text-align:center; }
    button.agregar { padding:10px 16px; background:#4CAF50; border:none; border-radius:6px; color:white; font-weight:bold; cursor:pointer; transition:background 0.3s; }
    button.agregar:hover:not(:disabled){ background:#388E3C; }
    button.agregar:disabled{ background:#a0c1a7; cursor:not-allowed; }
    #carritoDesplegable{ position:fixed; top:60px; right:20px; width:320px; max-height:400px; background:white; box-shadow:0 2px 12px rgba(0,0,0,0.3); border-radius:8px; overflow-y:auto; padding:1em; display:none; z-index:100; }
    #carritoDesplegable h3{ margin:0 0 1em; font-weight:bold; text-align:center; }
    .item-carrito{ display:flex; justify-content:space-between; align-items:center; margin-bottom:0.8em; border-bottom:1px solid #eee; padding-bottom:0.5em; }
    .item-carrito span{ flex:1; }
    .item-carrito .cantidad{ margin-left:1em; font-weight:bold; }
    .item-carrito button{ background:#d9534f; border:none; color:white; border-radius:6px; cursor:pointer; padding:4px 8px; font-weight:bold; margin-left:1em; }
    .item-carrito button:hover{ background:#b52b27; }
    #carritoAcciones { margin-top: 0.6em; display:flex; gap:8px; justify-content:center; }
    #carritoAcciones button { padding:8px 10px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }
    #verCarritoBtn { background:#4a90e2; color:white; }
    #vaciarCarritoBtn { background:#d9534f; color:white; }
    #mensajeAgregado{ position:fixed; bottom:20px; right:20px; background:white; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.2); padding:12px 16px; font-weight:bold; color:black; display:none; z-index:200; min-width:250px; }
    #mensajeAgregado span.producto-nombre{ display:block; margin-top:4px; font-weight:normal; }
  </style>
</head>
<body>
  <header>
    <button onclick="location.href='index.html'">⬅ Volver</button>
    <img src="imagenes/logo.png" alt="Logo" />
    <h1>Distribuidora Funaz</h1>
    <button onclick="location.href='admin.html'">Mi cuenta</button>
    <button id="btnCarritoHeader" onclick="toggleCarrito()">Carrito (0)</button>
  </header>

  <main>
    <div class="producto" id="detalle"></div>
  </main>

  <div id="carritoDesplegable">
    <h3>Carrito</h3>
    <div id="listaCarrito"></div>
    <div id="carritoAcciones">
      <button id="verCarritoBtn" onclick="verCarrito()">Ver carrito</button>
      <button id="vaciarCarritoBtn" onclick="vaciarCarrito()">Vaciar</button>
    </div>
  </div>

  <div id="mensajeAgregado"></div>

  <script>
    let carrito = [];
    let producto = null;
    let cantidadInput = null;
    let productos = [];

    // Initialize carrito from localStorage
    function initCarrito() {
      try {
        const storedCarrito = localStorage.getItem('carrito');
        carrito = storedCarrito ? JSON.parse(storedCarrito) : [];
        if (!Array.isArray(carrito)) {
          console.warn('Carrito en localStorage no es un array, inicializando como vacío');
          carrito = [];
          localStorage.setItem('carrito', JSON.stringify(carrito));
        }
        console.log('Carrito inicializado:', carrito);
      } catch (err) {
        console.error('Error al parsear carrito de localStorage:', err);
        carrito = [];
        localStorage.setItem('carrito', JSON.stringify(carrito));
      }
    }

    function actualizarContadorCarrito() {
      const listaCarrito = document.getElementById('listaCarrito');
      const btnCarritoHeader = document.getElementById('btnCarritoHeader');
      if (!listaCarrito || !btnCarritoHeader) {
        console.error('Elementos listaCarrito o btnCarritoHeader no encontrados');
        return;
      }
      const total = carrito.reduce((acc, i) => acc + (i.cantidad || 0), 0);
      btnCarritoHeader.textContent = `Carrito (${total})`;
      console.log('Contador de carrito actualizado:', total);
    }

    async function cargarProducto() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) {
        mostrarError('Producto no encontrado.');
        return;
      }

      try {
        const res = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/productos', { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}: No se pudo cargar productos`);
        productos = await res.json();
        producto = productos.find(p => p.id == id);
        if (!producto) throw new Error('Producto no encontrado');

        console.log('Producto cargado:', producto);

        const check = producto.stock > 0 ? '<span class="checkmark checked"></span>' : '<span class="checkmark"></span>';
        const existingItem = carrito.find(p => p.id == id);
        const initialCantidad = existingItem ? existingItem.cantidad : 1;

        document.getElementById('detalle').innerHTML = `
          <div class="imagen-container">
            <img src="imagenes/${producto.id}.png" onerror="this.onerror=null; this.src='imagenes/placeholder.png'" alt="Producto" />
          </div>
          <div class="detalle">
            <div>
              <div class="nombre">${producto.nombre}</div>
              <div class="precio">$${(producto.precio * 1.17).toFixed(2)}</div>
              <div class="stock" id="stockDisplay">
                ${check} Stock: ${producto.stock}
              </div>
            </div>
            <div class="acciones">
              <input type="number" id="cantidad" value="${initialCantidad}" min="1" />
              <button class="agregar" id="btnAgregar" onclick="agregarAlCarrito()">Agregar al carrito</button>
            </div>
          </div>
        `;

        cantidadInput = document.getElementById('cantidad');
        if (cantidadInput) {
          cantidadInput.addEventListener('wheel', (e) => {
            e.preventDefault();
            let valor = parseInt(cantidadInput.value) || 1;
            if (e.deltaY < 0) valor += 1; // rueda arriba → suma
            else valor = Math.max(1, valor - 1); // rueda abajo → no baja de 1
            cantidadInput.value = valor;
          });
          cantidadInput.addEventListener('input', () => {
            if (parseInt(cantidadInput.value) < 1) cantidadInput.value = 1;
          });
        } else {
          console.error('Elemento cantidad no encontrado después de cargar producto');
        }

        actualizarContadorCarrito();
        actualizarCarrito();
      } catch (err) {
        console.error('Error en cargarProducto:', err);
        mostrarError(`Error cargando producto: ${err.message}`);
      }
    }

    function mostrarError(msg) {
      const detalle = document.getElementById('detalle');
      if (detalle) {
        detalle.innerHTML = `<p style="color:red;font-weight:bold;">${msg}</p>`;
      } else {
        console.error('Elemento detalle no encontrado para mostrar error:', msg);
      }
    }

    function agregarAlCarrito() {
      if (!producto || !cantidadInput) {
        console.error('Producto o cantidadInput no definidos');
        mostrarError('Error: Producto no cargado o input no disponible');
        return;
      }

      let cantidad = parseInt(cantidadInput.value);
      if (isNaN(cantidad) || cantidad < 1) {
        console.warn('Cantidad inválida:', cantidadInput.value);
        cantidadInput.value = 1;
        return;
      }

      const existente = carrito.find(p => p.id === producto.id);
      const cantidadAnterior = existente ? existente.cantidad : 0;
      const diferencia = cantidad - cantidadAnterior;

      if (existente) {
        existente.cantidad = cantidad;
      } else {
        carrito.push({ id: producto.id, nombre: producto.nombre, precio: producto.precio, cantidad });
      }

      producto.stock -= diferencia; // Adjust stock based on difference
      if (producto.stock < 0) {
        console.warn(`Stock negativo para ${producto.nombre}: ${producto.stock}`);
      }
      updateStockDisplay();

      try {
        localStorage.setItem('carrito', JSON.stringify(carrito));
        console.log('Carrito guardado en localStorage:', carrito);
      } catch (err) {
        console.error('Error al guardar carrito en localStorage:', err);
      }

      actualizarCarrito();
      actualizarContadorCarrito();
      mostrarMensaje(producto.nombre, cantidad);
    }

    function updateStockDisplay() {
      const stockEl = document.getElementById('stockDisplay');
      if (stockEl && producto) {
        const check = producto.stock > 0 ? '<span class="checkmark checked"></span>' : '<span class="checkmark"></span>';
        stockEl.innerHTML = `${check} Stock: ${producto.stock}`;
      } else {
        console.warn('stockDisplay o producto no disponibles para actualizar');
      }
    }

    function mostrarMensaje(nombre, cantidad) {
      const msg = document.getElementById('mensajeAgregado');
      if (msg) {
        msg.innerHTML = `Se agregó:<br><span class="producto-nombre">${nombre} x${cantidad}</span>`;
        msg.style.display = 'block';
        clearTimeout(msg.timeoutId);
        msg.timeoutId = setTimeout(() => msg.style.display = 'none', 2000);
      } else {
        console.warn('mensajeAgregado no encontrado');
      }
    }

    function toggleCarrito() {
      const carritoDesplegable = document.getElementById('carritoDesplegable');
      if (carritoDesplegable) {
        carritoDesplegable.style.display = carritoDesplegable.style.display === 'block' ? 'none' : 'block';
        if (carritoDesplegable.style.display === 'block') {
          actualizarCarrito();
        }
      } else {
        console.error('carritoDesplegable no encontrado');
      }
    }

    function actualizarCarrito() {
      const lista = document.getElementById('listaCarrito');
      if (!lista) {
        console.error('listaCarrito no encontrado');
        return;
      }
      lista.innerHTML = '';

      if (carrito.length === 0) {
        lista.innerHTML = '<p>Carrito vacío.</p>';
        return;
      }

      carrito.forEach(item => {
        const prod = productos.find(p => p.id === item.id) || item;
        const div = document.createElement('div');
        div.className = 'item-carrito';
        div.innerHTML = `
          <span>${prod.nombre} x${item.cantidad}</span>
          <button onclick="removerDelCarrito(${item.id})">X</button>
        `;
        lista.appendChild(div);
      });
      console.log('Carrito actualizado:', carrito);
    }

    function removerDelCarrito(id) {
      const itemIndex = carrito.findIndex(i => i.id === id);
      if (itemIndex < 0) {
        console.warn('Item no encontrado en carrito:', id);
        return;
      }

      const item = carrito[itemIndex];
      if (producto && item.id === producto.id) {
        producto.stock += item.cantidad; // Restore stock
        updateStockDisplay();
      }

      carrito.splice(itemIndex, 1);
      try {
        localStorage.setItem('carrito', JSON.stringify(carrito));
        console.log('Item removido, carrito actualizado:', carrito);
      } catch (err) {
        console.error('Error al guardar carrito tras remover:', err);
      }

      actualizarCarrito();
      actualizarContadorCarrito();
    }

    function verCarrito() {
      location.href = 'carrito.html';
    }

    function vaciarCarrito() {
      if (!confirm('¿Vaciar todo el carrito?')) return;
      if (producto) {
        carrito.forEach(item => {
          if (item.id === producto.id) {
            producto.stock += item.cantidad; // Restore stock
          }
        });
        updateStockDisplay();
      }
      carrito = [];
      try {
        localStorage.setItem('carrito', JSON.stringify(carrito));
        console.log('Carrito vaciado');
      } catch (err) {
        console.error('Error al vaciar carrito en localStorage:', err);
      }
      actualizarCarrito();
      actualizarContadorCarrito();
    }

    // Handle cross-tab updates
    window.addEventListener('storage', (e) => {
      if (e.key === 'carrito') {
        try {
          carrito = JSON.parse(e.newValue) || [];
          console.log('Carrito actualizado desde storage event:', carrito);
          actualizarCarrito();
          actualizarContadorCarrito();
          // Update input field if product is loaded
          if (producto && cantidadInput) {
            const existingItem = carrito.find(p => p.id === producto.id);
            cantidadInput.value = existingItem ? existingItem.cantidad : 1;
          }
        } catch (err) {
          console.error('Error al parsear carrito desde storage event:', err);
          carrito = [];
          localStorage.setItem('carrito', JSON.stringify(carrito));
        }
      }
    });

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM cargado, inicializando carrito y producto');
      initCarrito();
      actualizarCarrito();
      actualizarContadorCarrito();
      cargarProducto();
    });
  </script>
</body>
</html>
