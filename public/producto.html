<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Detalle - Distribuidora Funaz</title>
  <style>
    :root {
      --primary-green: #2E7D32;
      --light-green: #4CAF50;
      --soft-green: #E8F5E9;
      --text-dark: #333;
      --bg-color: #fcfdfc;
      --white: #ffffff;
      --danger: #e57373;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
      font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif; 
      background: var(--bg-color); 
      color: var(--text-dark); 
      margin: 0; 
      min-height: 100vh; 
      display: flex; 
      flex-direction: column; 
    }

    /* HEADER */
    header { 
      background: var(--primary-green); 
      color: var(--white); 
      padding: 0.8em 1.5em; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      gap: 1em; 
      position: sticky; 
      top: 0; 
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
    }
    
    header h1 { font-size: 1.2em; font-weight: 600; margin: 0; display: none; } /* Oculto titulo en movil para espacio */
    @media(min-width: 768px) { header h1 { display: block; } }

    header button { 
      padding: 8px 14px; 
      border: none; 
      border-radius: 20px; 
      background: rgba(255,255,255,0.2); 
      color: var(--white); 
      font-weight: 600; 
      cursor: pointer; 
      font-size: 0.9em;
      transition: background 0.2s;
      display: flex; align-items: center; gap: 5px;
    }
    header button:hover { background: var(--white); color: var(--primary-green); }

    /* MAIN CARD */
    main { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 2em; }

    .producto-card { 
      background: var(--white); 
      border-radius: 20px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
      max-width: 900px; 
      width: 100%; 
      display: flex; 
      padding: 2.5em; 
      gap: 3em; 
      align-items: flex-start; 
      border: 1px solid #f0f0f0;
    }

    /* IMAGEN */
    .imagen-container { 
      flex: 1; 
      max-width: 400px;
      display: flex; justify-content: center; align-items: center;
      background: #f9f9f9;
      border-radius: 16px;
      padding: 1em;
    }
    .imagen-container img { 
      width: 100%; height: auto; max-height: 400px; 
      object-fit: contain; 
      mix-blend-mode: multiply; /* Truco para eliminar fondo blanco de imagenes */
    }

    /* DETALLES */
    .detalle { flex: 1; display: flex; flex-direction: column; justify-content: center; height: 100%; }
    
    .nombre { 
      font-size: 2em; 
      font-weight: 700; 
      margin-bottom: 0.2em; 
      line-height: 1.2; 
      color: var(--text-dark);
    }
    
    .precio { 
      font-size: 2.2em; 
      color: var(--primary-green); 
      font-weight: bold; 
      margin-bottom: 1em; 
    }

    /* CONTROL DE CANTIDAD (STEPPER) */
    .control-cantidad {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f5f5f5;
      padding: 5px;
      border-radius: 12px;
      width: fit-content;
      margin-bottom: 1.5em;
    }
    .control-cantidad button {
      width: 40px; height: 40px;
      border: none; background: var(--white);
      border-radius: 8px;
      font-size: 1.2em; font-weight: bold; color: var(--primary-green);
      cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: transform 0.1s;
    }
    .control-cantidad button:active { transform: scale(0.9); }
    
    .control-cantidad input {
      width: 50px; text-align: center;
      border: none; background: transparent;
      font-size: 1.2em; font-weight: bold;
      pointer-events: none; /* Evita teclado en movil, usa botones */
    }

    /* BOTON AGREGAR */
    button.agregar { 
      padding: 16px 32px; 
      background: var(--light-green); 
      border: none; 
      border-radius: 12px; 
      color: white; 
      font-size: 1.1em;
      font-weight: bold; 
      cursor: pointer; 
      transition: all 0.2s; 
      width: 100%;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    button.agregar:hover:not(:disabled) { background: var(--primary-green); transform: translateY(-2px); }
    button.agregar:active { transform: scale(0.98); }
    
    /* FEEDBACK AGREGADO */
    button.agregar.agregado { background: var(--primary-green); }
    button.agregar.agregado::after { content: " âœ“"; }

    .sin-stock { 
      color: var(--danger); 
      font-weight: bold; 
      font-size: 1.2em; 
      background: #ffebee; 
      padding: 10px 20px; 
      border-radius: 8px; 
      display: inline-block;
    }

    /* CARRITO MODAL FLOTANTE */
    #carritoDesplegable { 
      position: fixed; top: 70px; right: 20px; width: 320px; max-height: 80vh; 
      background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
      border-radius: 16px; overflow-y: auto; padding: 1.5em; 
      display: none; z-index: 1000; border: 1px solid #eee;
    }
    .item-carrito { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8em; border-bottom: 1px solid #f0f0f0; padding-bottom: 0.5em; }
    .item-carrito button { background: #ffebee; color: var(--danger); border: none; border-radius: 6px; width: 25px; height: 25px; cursor: pointer; font-weight: bold; }
    
    #carritoAcciones { display: flex; gap: 10px; margin-top: 15px; }
    #carritoAcciones button { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    #verCarritoBtn { background: var(--primary-green); color: white; }
    #vaciarCarritoBtn { background: var(--danger); color: white; }

    /* TOAST NOTIFICATION */
    #mensajeAgregado { 
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: #333; color: white; border-radius: 50px; 
      box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
      padding: 12px 25px; font-weight: 500; text-align: center;
      display: block; opacity: 0; pointer-events: none; z-index: 2000;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      min-width: auto; width: max-content;
    }
    #mensajeAgregado.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* --- RESPONSIVE MOBILE --- */
    @media (max-width: 768px) {
      body { background: var(--white); } /* Fondo blanco en movil se ve mas limpio */
      main { padding: 0; }
      
      header { padding: 10px 15px; }
      header button span { display: none; } /* Solo iconos en header movil si es necesario */

      .producto-card {
        flex-direction: column;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        gap: 0;
        border: none;
      }

      .imagen-container {
        width: 100%;
        max-width: 100%;
        height: 35vh;
        border-radius: 0 0 20px 20px;
        background: #f5f5f5;
        margin-bottom: 20px;
        padding: 20px;
      }
      .imagen-container img { height: 100%; max-height: none; }

      .detalle { padding: 0 20px 40px 20px; width: 100%; display: block; }
      
      .nombre { font-size: 1.5em; }
      .precio { font-size: 1.8em; margin-bottom: 0.8em; }

      .acciones {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .control-cantidad { width: 100%; justify-content: space-between; padding: 10px; border-radius: 16px; margin-bottom: 10px; }
      .control-cantidad button { width: 50px; height: 50px; border-radius: 12px; }
      
      button.agregar { padding: 18px; font-size: 1.2em; border-radius: 16px; position: sticky; bottom: 20px; box-shadow: 0 10px 20px rgba(76, 175, 80, 0.4); }

      #carritoDesplegable { width: 90%; top: 50%; left: 50%; transform: translate(-50%, -50%); right: auto; }
    }
  </style>
</head>
<body>
  <header>
    <button onclick="location.href='index.html'">â¬… Volver</button>
    <h1>Detalle</h1>
    <div style="display:flex; gap:10px;">
        <button onclick="location.href='admin.html'">ðŸ‘¤</button>
        <button id="btnCarritoHeader" onclick="toggleCarrito()">ðŸ›’ (0)</button>
    </div>
  </header>

  <main>
    <div class="producto-card" id="detalle">
        <p style="padding:20px; width:100%; text-align:center;">Cargando producto...</p>
    </div>
  </main>

  <div id="carritoDesplegable">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color:var(--primary-green);">Tu Carrito</h3>
        <button onclick="toggleCarrito()" style="background:none; border:none; font-size:1.5em; color:#999;">&times;</button>
    </div>
    <div id="listaCarrito"></div>
    <div id="carritoAcciones">
      <button id="vaciarCarritoBtn" onclick="vaciarCarrito()">Vaciar</button>
      <button id="verCarritoBtn" onclick="verCarrito()">Ver Carrito Completo</button>
    </div>
  </div>

  <div id="mensajeAgregado"></div>

  <script>
    let carrito = [];
    let producto = null;
    let cantidadInput = null;
    let productos = [];

    function initCarrito() {
      try {
        const storedCarrito = localStorage.getItem('carrito');
        carrito = storedCarrito ? JSON.parse(storedCarrito) : [];
        if (!Array.isArray(carrito)) carrito = [];
      } catch (err) {
        carrito = [];
      }
      localStorage.setItem('carrito', JSON.stringify(carrito));
    }

    function actualizarContadorCarrito() {
      const btnCarritoHeader = document.getElementById('btnCarritoHeader');
      const total = carrito.reduce((acc, i) => acc + (i.cantidad || 0), 0);
      btnCarritoHeader.textContent = `ðŸ›’ (${total})`;
    }

    function getImageUrl(fileName) {
      if (!fileName) return '';
      const cleanFileName = fileName.trim().replace(/^imagenes\//, '');
      return `https://slroycxifwezthdomkny.supabase.co/storage/v1/object/public/imagenes/${cleanFileName}`;
    }

    async function cargarProducto() {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return mostrarError('Producto no especificado.');

      try {
        const res = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/productos', { cache: 'no-store' });
        if (!res.ok) throw new Error();
        productos = await res.json();
        producto = productos.find(p => String(p.id) === String(id));
        
        if (!producto) throw new Error("Producto no encontrado");

        const existingItem = carrito.find(p => p.id == id);
        const initialCantidad = existingItem ? existingItem.cantidad : 1;
        
        let accionesHTML = '';
        if (producto.stock <= -99) {
          accionesHTML = '<div class="sin-stock">ðŸš« SIN STOCK</div>';
        } else {
          // AQUI ESTA EL CAMBIO VISUAL DEL STEPPER
          accionesHTML = `
            <div class="acciones">
              <div class="control-cantidad">
                <button onclick="disminuirCantidad()">-</button>
                <input type="number" id="cantidad" value="${initialCantidad}" readonly />
                <button onclick="aumentarCantidad()">+</button>
              </div>
              <button class="agregar" id="btnAgregar" onclick="agregarAlCarrito(this)">Agregar al Carrito</button>
            </div>
          `;
        }

        const detalleDiv = document.getElementById('detalle');
        detalleDiv.innerHTML = `
          <div class="imagen-container">
            <img id="mainImage" src="${getImageUrl('placeholder.png')}" alt="${producto.nombre}">
          </div>
          <div class="detalle">
            <div class="nombre">${producto.nombre}</div>
            <div class="precio">$${(producto.precio * 1.1).toFixed(2)}</div>
            <div style="flex-grow:1;"></div> ${accionesHTML}
          </div>
        `;

        if (producto.imagen) {
            const publicUrl = getImageUrl(producto.imagen);
            const img = document.getElementById('mainImage');
            const realImg = new Image();
            realImg.src = publicUrl;
            realImg.onload = () => { img.src = publicUrl; };
        }

        if (producto.stock > -99) {
          cantidadInput = document.getElementById('cantidad');
        }
        
        actualizarContadorCarrito();
        actualizarCarrito();

      } catch (err) {
        mostrarError(`No se pudo cargar el producto.`);
        console.error(err);
      }
    }

    // Funciones nuevas para los botones + y -
    function aumentarCantidad() {
        let val = parseInt(cantidadInput.value) || 1;
        cantidadInput.value = val + 1;
    }

    function disminuirCantidad() {
        let val = parseInt(cantidadInput.value) || 1;
        if (val > 1) cantidadInput.value = val - 1;
    }

    function mostrarError(msg) {
      document.getElementById('detalle').innerHTML = `<p style="color:#e53935;font-weight:bold;text-align:center;width:100%;padding:2em;">${msg}</p>`;
    }

    function agregarAlCarrito(btnElement) {
      if (!producto || (producto.stock <= -99)) return;

      let cantidad = parseInt(cantidadInput.value);
      if (isNaN(cantidad) || cantidad < 1) cantidad = 1;

      const existente = carrito.find(p => p.id === producto.id);
      if (existente) existente.cantidad = cantidad;
      else carrito.push({ id: producto.id, nombre: producto.nombre, precio: producto.precio, cantidad });

      localStorage.setItem('carrito', JSON.stringify(carrito));
      
      // Feedback Visual y Tactil
      if(btnElement) {
        const originalText = btnElement.innerText;
        btnElement.innerText = "Â¡Listo!";
        btnElement.classList.add('agregado');
        if (navigator.vibrate) navigator.vibrate(50);
        
        setTimeout(() => {
            btnElement.innerText = originalText;
            btnElement.classList.remove('agregado');
        }, 1500);
      }

      actualizarCarrito();
      actualizarContadorCarrito();
      mostrarMensajeToast(`${producto.nombre} (x${cantidad})`);
    }

    function mostrarMensajeToast(texto) {
      const msg = document.getElementById('mensajeAgregado');
      msg.textContent = `Guardado: ${texto}`;
      msg.classList.add('visible');
      
      if(msg.timeoutId) clearTimeout(msg.timeoutId);
      
      msg.timeoutId = setTimeout(() => {
        msg.classList.remove('visible');
      }, 2500);
    }

    function toggleCarrito() {
      const c = document.getElementById('carritoDesplegable');
      c.style.display = c.style.display === 'block' ? 'none' : 'block';
      if (c.style.display === 'block') actualizarCarrito();
    }

    function actualizarCarrito() {
      const lista = document.getElementById('listaCarrito');
      lista.innerHTML = '';
      if (carrito.length === 0) {
        lista.innerHTML = '<p style="text-align:center;color:#888;">Carrito vacÃ­o.</p>';
        return;
      }
      carrito.forEach(item => {
        const prod = productos.find(p => p.id === item.id) || item;
        const div = document.createElement('div');
        div.className = 'item-carrito';
        div.innerHTML = `
          <span>${prod.nombre} <b>x${item.cantidad}</b></span>
          <button onclick="removerDelCarrito(${item.id})">âœ•</button>
        `;
        lista.appendChild(div);
      });
    }

    function removerDelCarrito(id) {
      const itemIndex = carrito.findIndex(i => i.id === id);
      if (itemIndex > -1) {
        carrito.splice(itemIndex, 1);
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarCarrito();
        actualizarContadorCarrito();
        // Si borramos el item que estamos viendo, resetear input a 1
        if (producto && producto.id == id && cantidadInput) cantidadInput.value = 1;
      }
    }

    function verCarrito() { location.href = 'carrito.html'; }
    
    function vaciarCarrito() {
      if (confirm('Â¿Vaciar todo?')) {
        carrito = [];
        localStorage.setItem('carrito', JSON.stringify(carrito));
        actualizarCarrito();
        actualizarContadorCarrito();
        if (cantidadInput) cantidadInput.value = 1;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initCarrito();
      actualizarContadorCarrito();
      cargarProducto();
    });
  </script>
</body>
</html>
