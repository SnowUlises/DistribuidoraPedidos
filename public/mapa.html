<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa Logística</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        /* UI Flotante */
        .float-btn { position: absolute; background: white; width: 50px; height: 50px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; }
        #btn-add { bottom: 20px; right: 20px; font-size: 24px; color: #333; }
        #btn-list { top: 20px; left: 20px; width: 40px; height: 40px; }
        #btn-global { top: 20px; right: 20px; width: auto; padding: 0 15px; border-radius: 20px; font-weight: bold; font-size: 14px; color: #555; }
        #btn-global.active { background: #e8f0fe; color: #1a73e8; }

        /* Pin Central (Modo Agregar) */
        #center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 900; pointer-events: none; display: none; color: #ea4335; font-size: 40px; }
        #btn-confirm { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: black; color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000; cursor: pointer; display: none; }

        /* Panel Detalles */
        #sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-radius: 15px 15px 0 0; transform: translateY(100%); transition: 0.3s; z-index: 1001; padding-bottom: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; }
        #sheet.open { transform: translateY(0); }
        .sheet-body { padding: 20px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; margin-top: 5px; font-weight: bold; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-red { background: #d93025; color: white; }
        .btn-gray { background: #f1f3f4; color: #333; }

        /* Sidebar */
        #sidebar { position: absolute; top: 0; left: 0; height: 100%; width: 300px; background: white; z-index: 1002; transform: translateX(-100%); transition: 0.3s; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
        #sidebar.open { transform: translateX(0); }
        .list-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .list-item:hover { background: #f5f5f5; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="btn-list" class="float-btn"><i class="fa-solid fa-bars"></i></div>
    <div id="btn-global" class="float-btn active">Globales</div>
    <div id="btn-add" class="float-btn"><i class="fa-solid fa-plus"></i></div>

    <div id="center-pin"><i class="fa-solid fa-location-dot"></i></div>
    <div id="btn-confirm">Confirmar Ubicación</div>

    <div id="sheet">
        <div class="sheet-body">
            <div id="form-view" style="display:none;">
                <h3>Dirección</h3>
                <input id="inp-name" placeholder="Nombre (ej. Kiosco Pepe)">
                <input id="inp-notes" placeholder="Notas">
                <input id="inp-link" placeholder="Link Google Maps">
                
                <div id="box-members" style="display:none; margin-bottom:10px;">
                    <small>Compartir con:</small>
                    <div style="display:flex; gap:5px;">
                        <input id="inp-invite" placeholder="email@vendedor.com" style="margin:0;">
                        <button id="btn-invite-add" style="width:40px;">+</button>
                    </div>
                    <ul id="list-members" style="padding-left:20px; margin-top:5px; font-size:14px;"></ul>
                </div>

                <button id="btn-save" class="btn-blue">Guardar</button>
                <button id="btn-delete" class="btn-red" style="display:none;">Eliminar</button>
                <button onclick="closeSheet()" class="btn-gray">Cancelar</button>
            </div>

            <div id="read-view" style="display:none;">
                <h2 id="txt-name" style="margin-top:0;"></h2>
                <p id="txt-notes" style="color:#666;"></p>
                <a id="lnk-maps" href="#" target="_blank" style="display:block; margin-bottom:15px; color:#1a73e8;">Ver en Google Maps</a>
                <button id="btn-edit" class="btn-gray">Editar</button>
                <button id="btn-leave" class="btn-red" style="display:none;">Dejar de seguir</button>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">Mis Direcciones <span onclick="toggleSidebar()" style="float:right; cursor:pointer;">x</span></div>
        <div id="sidebar-list"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CLIENTE SIMPLE ---
        let map, markers = [], locations = [], isAdding = false, showGlobals = true;
        let token, myId, myEmail;

        // 1. Obtener Token del Login (LocalStorage estándar de Supabase)
        function getSession() {
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith('sb-') && k.endsWith('-auth-token')) {
                    return JSON.parse(localStorage.getItem(k));
                }
            }
            return null;
        }

        // 2. Fetch Centralizado (Usa tu backend)
        async function api(url, method = 'GET', data = null) {
            const opts = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
            if (data) opts.body = JSON.stringify(data);
            const res = await fetch(url, opts);
            if (res.status === 401) window.location.href = 'login.html';
            return res.json();
        }

        async function init() {
            const session = getSession();
            if (!session) return window.location.href = 'login.html';
            token = session.access_token;
            myId = session.user.id;
            myEmail = session.user.email;

            initMap();
            loadData();
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([-31.5375, -68.5364], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        }

        async function loadData() {
            try {
                locations = await api('/api/direcciones'); // Llama a tu server.js
                renderMap();
            } catch (e) { console.error(e); }
        }

        function renderMap() {
            markers.forEach(m => map.removeLayer(m)); markers = [];
            
            locations.forEach(loc => {
                if (loc.is_global && !showGlobals) return;
                
                const isMine = loc.created_by === myId;
                const color = loc.is_global ? '#1a73e8' : (isMine ? '#d93025' : '#f9ab00'); // Azul, Rojo, Naranja
                
                const icon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background:${color};width:14px;height:14px;border:2px solid white;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [18, 18]
                });

                const m = L.marker([loc.lat, loc.lng], { icon }).addTo(map);
                m.on('click', () => { showDetails(loc); map.setView([loc.lat, loc.lng], 16); });
                markers.push(m);
            });
        }

        // --- UI & Lógica ---
        
        // Agregar
        document.getElementById('btn-add').onclick = () => {
            isAdding = !isAdding;
            document.getElementById('center-pin').style.display = isAdding ? 'block' : 'none';
            document.getElementById('btn-confirm').style.display = isAdding ? 'block' : 'none';
            closeSheet();
        };

        document.getElementById('btn-confirm').onclick = () => {
            const c = map.getCenter();
            document.getElementById('btn-add').click(); // Salir modo agregar
            openForm(null, c);
        };

        // Formulario
        const sheet = document.getElementById('sheet');
        const closeSheet = () => sheet.classList.remove('open');

        function openForm(loc, coords) {
            document.getElementById('read-view').style.display = 'none';
            document.getElementById('form-view').style.display = 'block';
            
            // Llenar campos
            document.getElementById('inp-name').value = loc ? loc.name : '';
            document.getElementById('inp-notes').value = loc ? loc.notes || '' : '';
            document.getElementById('inp-link').value = loc ? loc.gmaps_link || '' : '';

            // Lógica Miembros (Solo si soy dueño)
            const memBox = document.getElementById('box-members');
            const memList = document.getElementById('list-members');
            memList.innerHTML = '';

            if (loc && loc.created_by === myId) {
                memBox.style.display = 'block';
                document.getElementById('btn-delete').style.display = 'block';
                
                (loc.members || []).forEach(m => {
                    memList.innerHTML += `<li>${m} <span style="color:red;cursor:pointer" onclick="modMember('${loc.id}', '${m}', 'del')">x</span></li>`;
                });

                document.getElementById('btn-invite-add').onclick = () => {
                    const mail = document.getElementById('inp-invite').value;
                    if(mail) modMember(loc.id, mail, 'add');
                };
                
                document.getElementById('btn-save').onclick = () => saveData(loc.id);
                document.getElementById('btn-delete').onclick = () => deleteData(loc.id);
            } else {
                memBox.style.display = 'none';
                document.getElementById('btn-delete').style.display = 'none';
                document.getElementById('btn-save').onclick = () => saveData(null, coords);
            }
            sheet.classList.add('open');
        }

        function showDetails(loc) {
            document.getElementById('form-view').style.display = 'none';
            document.getElementById('read-view').style.display = 'block';
            
            document.getElementById('txt-name').innerText = loc.name;
            document.getElementById('txt-notes').innerText = loc.notes || '';
            const lnk = document.getElementById('lnk-maps');
            lnk.href = loc.gmaps_link || '#';
            lnk.style.display = loc.gmaps_link ? 'block' : 'none';

            const btnEdit = document.getElementById('btn-edit');
            const btnLeave = document.getElementById('btn-leave');

            if (loc.created_by === myId) {
                btnEdit.style.display = 'block'; btnEdit.onclick = () => openForm(loc);
                btnLeave.style.display = 'none';
            } else if (loc.is_global) {
                btnEdit.style.display = 'none'; btnLeave.style.display = 'none';
            } else {
                btnEdit.style.display = 'none';
                btnLeave.style.display = 'block';
                btnLeave.onclick = () => modMember(loc.id, myEmail, 'del'); // Salir
            }
            sheet.classList.add('open');
        }

        // Operaciones
        async function saveData(id, coords) {
            const body = {
                name: document.getElementById('inp-name').value,
                notes: document.getElementById('inp-notes').value,
                gmaps_link: document.getElementById('inp-link').value
            };
            if(!body.name) return;

            if (id) await api(`/api/direcciones/${id}`, 'PUT', body);
            else await api('/api/direcciones', 'POST', { ...body, lat: coords.lat, lng: coords.lng });
            
            closeSheet(); loadData();
        }

        async function deleteData(id) {
            if(confirm('¿Borrar?')) { await api(`/api/direcciones/${id}`, 'DELETE'); closeSheet(); loadData(); }
        }

        async function modMember(id, email, action) {
            const loc = locations.find(l => l.id === id);
            let mems = loc.members || [];
            if (action === 'add') { if(!mems.includes(email)) mems.push(email); }
            else { mems = mems.filter(m => m !== email); }

            await api(`/api/direcciones/${id}`, 'PUT', { members: mems });
            
            if (action === 'del' && email === myEmail) { closeSheet(); } // Me fui
            else { loc.members = mems; openForm(loc); } // Refrescar
            loadData();
        }

        // Globales / Lista
        document.getElementById('btn-global').onclick = (e) => {
            showGlobals = !showGlobals;
            e.target.classList.toggle('active');
            renderMap();
        };

        const sb = document.getElementById('sidebar');
        function toggleSidebar() { sb.classList.toggle('open'); renderList(); }
        document.getElementById('btn-list').onclick = toggleSidebar;

        function renderList() {
            const list = document.getElementById('sidebar-list'); list.innerHTML = '';
            
            const createItem = (l) => {
                const d = document.createElement('div'); d.className = 'list-item';
                d.innerText = l.name + (l.is_global ? ' (Global)' : '');
                d.onclick = () => { toggleSidebar(); map.setView([l.lat, l.lng], 16); showDetails(l); };
                list.appendChild(d);
            };

            locations.filter(l => l.is_global && showGlobals).forEach(createItem);
            locations.filter(l => l.created_by === myId && !l.is_global).forEach(createItem);
            locations.filter(l => l.created_by !== myId && !l.is_global).forEach(createItem);
        }

        init();
    </script>
</body>
</html>
