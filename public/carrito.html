<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Distribuidora Funaz</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { brand: { 400: '#a3e635', 500: '#84cc16', 600: '#65a30d' } } }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1f2937; padding-bottom: 120px; }
        .mono-num { font-family: 'JetBrains Mono', monospace; }
        
        /* Oculta la app hasta que cargue para no ver {{ }} */
        [v-cloak] { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" v-cloak class="flex-1 max-w-3xl mx-auto w-full p-4 md:p-8">
        
        <header class="flex items-center justify-between mb-8">
            <a href="index.html" class="flex items-center gap-2 text-gray-600 hover:text-brand-600 font-bold text-sm bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm">
                â¬… Seguir comprando
            </a>
            <h1 class="text-xl font-bold tracking-tight text-gray-900">Mi Carrito</h1>
            <div class="w-8"></div> 
        </header>

        <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
            <div class="w-10 h-10 border-4 border-brand-500 border-t-transparent rounded-full animate-spin mb-3"></div>
            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Cargando...</span>
        </div>

        <div v-else-if="itemsDetalle.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
            <div class="bg-gray-100 p-6 rounded-full mb-4 text-4xl">ðŸ›’</div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Tu carrito estÃ¡ vacÃ­o</h2>
            <a href="index.html" class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg mt-4 inline-block">
                Ir a la Tienda
            </a>
        </div>

        <div v-else class="space-y-4 pb-24">
            <div v-for="(item, index) in itemsDetalle" :key="item.id" class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex gap-4 items-center relative overflow-hidden">
                <div class="w-20 h-20 bg-gray-50 rounded-lg flex-shrink-0 p-2 flex items-center justify-center border border-gray-100">
                    <img :src="item.imagenUrl" class="w-full h-full object-contain" alt="Prod">
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-gray-800 text-sm leading-tight mb-1 truncate">{{ item.nombre }}</h3>
                    <div class="text-xs text-gray-500 mb-2">{{ formatMoney(item.precioUnitario) }} c/u</div>
                    <div class="font-bold text-brand-600 mono-num">{{ formatMoney(item.subtotal) }}</div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 p-1">
                        <button @click="cambiarCantidad(index, -1)" class="w-8 h-8 flex items-center justify-center font-bold text-gray-600 hover:bg-white rounded">-</button>
                        <span class="w-8 text-center font-bold text-sm text-gray-800">{{ item.cantidad }}</span>
                        <button @click="cambiarCantidad(index, 1)" class="w-8 h-8 flex items-center justify-center font-bold text-brand-600 hover:bg-white rounded">+</button>
                    </div>
                    <button @click="eliminar(index)" class="text-xs text-red-400 font-medium p-1">Eliminar</button>
                </div>
            </div>
        </div>

        <div v-if="itemsDetalle.length > 0" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg z-40">
            <div class="max-w-3xl mx-auto flex flex-col gap-3">
                <div class="flex justify-between items-end px-1">
                    <span class="text-sm font-medium text-gray-500 uppercase">Total</span>
                    <span class="text-2xl font-black text-gray-900 mono-num">{{ formatMoney(totalGeneral) }}</span>
                </div>
                <button @click="modalAbierto = true" class="w-full bg-brand-500 hover:bg-brand-600 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg">
                    Confirmar Pedido
                </button>
            </div>
        </div>

        <div v-if="modalAbierto" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm" @click.self="modalAbierto = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative">
                <button @click="modalAbierto = false" class="absolute top-4 right-4 text-gray-400 p-2 font-bold text-xl">&times;</button>

                <h3 class="text-xl font-bold text-gray-900 mb-2">Datos de EnvÃ­o</h3>
                <p class="text-sm text-gray-500 mb-6">Completa la informaciÃ³n.</p>

                <div class="space-y-4">
                    <div v-if="sesionActiva" class="bg-brand-50 border border-brand-200 rounded-xl p-3 mb-2 flex items-center gap-3">
                        <div class="bg-brand-200 p-2 rounded-full text-brand-700">ðŸ‘¤</div>
                        <div class="overflow-hidden">
                            <div class="text-[10px] text-brand-600 font-bold uppercase">Enviando como</div>
                            <div class="text-sm font-bold text-gray-800 truncate">{{ nombreUsuario }}</div>
                        </div>
                    </div>

                    <div v-if="!sesionActiva">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                        <input v-model="form.nombre" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm mb-3">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Apellido</label>
                        <input v-model="form.apellido" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Negocio</label>
                        <input v-model="form.negocio" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm" placeholder="Ej: Kiosco...">
                    </div>

                    <button @click="enviarPedido" :disabled="enviando" class="w-full bg-brand-500 text-white py-3 rounded-xl font-bold shadow-md mt-4 disabled:bg-gray-300">
                        <span v-if="enviando">Enviando...</span>
                        <span v-else>Enviar Pedido</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscm95Y3hpZndlenRoZG9ta255Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjI3MjM0MiwiZXhwIjoyMDcxODQ4MzQyfQ.s7vfcg-sqZw-VxXUnOCyroi7oTyzfx0i4siNeDOW6lE';
        const API_BASE = 'https://distribuidorafunaz-a2o6.onrender.com/api';

        const { createApp } = Vue;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            data() {
                return {
                    loading: true,
                    modalAbierto: false,
                    enviando: false,
                    productos: [],
                    carrito: [], // Array simple: {id, cantidad}
                    sesionActiva: false,
                    userId: null,
                    userData: null,
                    form: { nombre: '', apellido: '', negocio: '' }
                }
            },
            computed: {
                // Cruzamos el carrito (ID) con los productos descargados
                itemsDetalle() {
                    return this.carrito.map(item => {
                        // Buscamos el producto en la lista descargada
                        const prod = this.productos.find(p => String(p.id) === String(item.id));
                        if (!prod) return null; // Si el producto se borrÃ³ de la base de datos

                        const precio = Number(prod.precio) || 0;
                        const precioFinal = precio * 1.10;
                        
                        let img = 'https://via.placeholder.com/100?text=IMG';
                        if (prod.imagen) {
                            // Limpieza manual de la URL
                            const cleanPath = prod.imagen.replace('imagenes/', '');
                            img = `${SUPABASE_URL}/storage/v1/object/public/imagenes/${cleanPath}`;
                        }

                        return {
                            id: item.id,
                            cantidad: item.cantidad,
                            nombre: prod.nombre,
                            precioUnitario: precioFinal,
                            subtotal: precioFinal * item.cantidad,
                            imagenUrl: img
                        };
                    }).filter(x => x !== null);
                },
                totalGeneral() {
                    return this.itemsDetalle.reduce((acc, i) => acc + i.subtotal, 0);
                },
                nombreUsuario() {
                    if (!this.userData) return '';
                    const meta = this.userData.user_metadata || {};
                    return meta.full_name || meta.name || this.userData.email;
                }
            },
            async mounted() {
                // 1. Cargar Usuario
                try {
                    const { data } = await supabase.auth.getSession();
                    if (data && data.session) {
                        this.sesionActiva = true;
                        this.userId = data.session.user.id;
                        this.userData = data.session.user;
                    }
                } catch (e) { console.error(e); }

                // 2. Leer LocalStorage (Igual que en index.html)
                try {
                    const raw = localStorage.getItem('carrito');
                    if (raw) {
                        this.carrito = JSON.parse(raw);
                        if (!Array.isArray(this.carrito)) this.carrito = [];
                    }
                } catch (e) { this.carrito = []; }

                // 3. Cargar Productos de la API
                await this.fetchProductos();
                
                // 4. Iconos
                if (typeof lucide !== 'undefined') lucide.createIcons();
            },
            updated() {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            },
            methods: {
                async fetchProductos() {
                    try {
                        const res = await fetch(API_BASE + '/productos');
                        if (res.ok) {
                            this.productos = await res.json();
                        }
                    } catch (e) { console.error("Err prod", e); }
                    this.loading = false;
                },
                
                guardarStorage() {
                    localStorage.setItem('carrito', JSON.stringify(this.carrito));
                },

                cambiarCantidad(index, delta) {
                    // Nota: 'index' viene del v-for de itemsDetalle.
                    // Necesitamos encontrar el Ã­ndice real en this.carrito
                    const itemVisual = this.itemsDetalle[index];
                    const realIndex = this.carrito.findIndex(c => String(c.id) === String(itemVisual.id));
                    
                    if (realIndex === -1) return;

                    const nuevaCant = this.carrito[realIndex].cantidad + delta;
                    if (nuevaCant > 0) {
                        this.carrito[realIndex].cantidad = nuevaCant;
                    } else {
                        this.carrito.splice(realIndex, 1);
                    }
                    this.guardarStorage();
                },

                eliminar(index) {
                    const itemVisual = this.itemsDetalle[index];
                    const realIndex = this.carrito.findIndex(c => String(c.id) === String(itemVisual.id));
                    if (realIndex !== -1) {
                        this.carrito.splice(realIndex, 1);
                        this.guardarStorage();
                    }
                },

                formatMoney(val) {
                    return '$' + (Number(val) || 0).toLocaleString('es-AR');
                },

                async enviarPedido() {
                    // Validaciones bÃ¡sicas
                    if (!this.form.negocio) return alert("Falta el nombre del negocio");
                    if (!this.sesionActiva && !this.form.nombre) return alert("Falta tu nombre");

                    this.enviando = true;

                    try {
                        let nombreFinal = '';
                        if (this.sesionActiva) {
                            nombreFinal = this.nombreUsuario || 'Usuario Registrado';
                        } else {
                            nombreFinal = this.form.nombre + ' ' + this.form.apellido;
                        }

                        // Preparamos datos simples para enviar
                        const itemsEnviar = this.itemsDetalle.map(i => ({
                            id: i.id,
                            cantidad: i.cantidad,
                            precio: i.precioUnitario
                        }));

                        const payload = {
                            nombre: nombreFinal,
                            telefono: 'No solicitado',
                            items: itemsEnviar,
                            total: this.totalGeneral,
                            user_id: this.userId,
                            nombre_negocio: this.form.negocio
                        };

                        const res = await fetch(API_BASE + '/Enviar-Peticion', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) throw new Error("Error en servidor");

                        // Limpiar y salir
                        this.carrito = [];
                        this.guardarStorage();
                        this.modalAbierto = false;
                        alert("Â¡Pedido enviado!");
                        
                        window.location.href = this.sesionActiva ? 'mi-cuenta.html' : 'index.html';

                    } catch (e) {
                        alert("Error al enviar: " + e.message);
                    } finally {
                        this.enviando = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
