<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle - Distribuidora Funaz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 400: '#a3e635', 500: '#84cc16', 600: '#65a30d' }, // Lima
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1f2937; }
        .mono-num { font-family: 'JetBrains Mono', monospace; }
        
        /* Animación Fade */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        /* Toast */
        #mensajeAgregado {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #1f2937; color: white; padding: 12px 24px; border-radius: 50px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); font-weight: 600; font-size: 0.9em;
            z-index: 2000; opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 8px; width: max-content; max-width: 90%;
        }
        #mensajeAgregado.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Estilo para error */
        #mensajeAgregado.error { background: #7f1d1d; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" class="flex-1 max-w-5xl mx-auto w-full p-4 md:p-8">
        
        <header class="flex items-center justify-between mb-8">
            <a href="index.html" class="flex items-center gap-2 text-gray-600 hover:text-brand-600 transition-colors font-bold text-sm bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver
            </a>
            
            <div class="flex items-center gap-2">
                <a href="login.html" class="p-2 text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </a>
                <button @click="toggleCarrito" class="bg-brand-500 hover:bg-brand-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm transition-all active:scale-95">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i> <span>({{ cantidadTotalCarrito }})</span>
                </button>
            </div>
        </header>

        <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
            <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-3 text-brand-500"></i>
            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Cargando producto...</span>
        </div>

        <div v-else-if="error" class="text-center py-20">
            <div class="bg-red-50 p-4 rounded-xl text-red-600 font-bold inline-block border border-red-100">
                {{ error }}
            </div>
            <div class="mt-4">
                <a href="index.html" class="text-gray-500 underline hover:text-gray-800 text-sm">Volver al inicio</a>
            </div>
        </div>

        <div v-else-if="producto" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col md:flex-row">
            
            <div class="w-full md:w-1/2 bg-gray-50 p-8 flex items-center justify-center border-b md:border-b-0 md:border-r border-gray-100 relative">
                <img :src="imagenUrl" :alt="producto.nombre" class="w-full h-auto max-h-[400px] object-contain mix-blend-multiply">
                
                <div v-if="stockDisponible <= 0" class="absolute top-4 left-4 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-sm">
                    Agotado
                </div>
            </div>

            <div class="w-full md:w-1/2 p-6 md:p-10 flex flex-col justify-center">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2 leading-tight">{{ producto.nombre }}</h1>
                <div class="text-3xl font-bold text-brand-600 mb-6 mono-num">${{ formatMoney(precioFinal) }}</div>

                <div v-if="stockDisponible > 0" class="space-y-6">
                    
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-gray-400 uppercase tracking-wider">Cantidad:</span>
                        <div class="flex items-center bg-gray-50 rounded-xl border border-gray-200 p-1">
                            <button @click="disminuir" class="w-10 h-10 flex items-center justify-center text-gray-600 hover:bg-white hover:shadow-sm rounded-lg transition-all font-bold text-lg">-</button>
                            <input type="number" v-model.number="cantidad" @change="validarInput" class="w-12 text-center bg-transparent font-bold text-gray-800 outline-none mono-num" min="1">
                            <button @click="aumentar" class="w-10 h-10 flex items-center justify-center text-brand-600 hover:bg-white hover:shadow-sm rounded-lg transition-all font-bold text-lg">+</button>
                        </div>
                    </div>

                    <button @click="agregarAlCarrito" 
                            class="w-full bg-brand-500 hover:bg-brand-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-brand-200 transition-all hover:-translate-y-1 active:scale-95 flex justify-center items-center gap-2"
                            :class="{'bg-green-600 scale-95': agregadoFeedback}">
                        <span v-if="agregadoFeedback">¡Agregado!</span>
                        <span v-else>Agregar al Carrito</span>
                        <i v-if="!agregadoFeedback" data-lucide="shopping-bag" class="w-5 h-5"></i>
                        <i v-else data-lucide="check" class="w-5 h-5"></i>
                    </button>
                    
                    </div>

                <div v-else class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center text-gray-500 font-medium text-sm">
                    Este producto no está disponible por el momento.
                </div>
            </div>
        </div>

        <div v-if="carritoAbierto" class="fixed inset-0 z-50 flex justify-end" @click.self="toggleCarrito">
            <div class="w-full max-w-sm bg-white h-full shadow-2xl p-6 flex flex-col animate-slide-in-right" @click.stop>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-gray-900 text-lg">Tu Carrito</h3>
                    <button @click="toggleCarrito" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                
                <div class="flex-1 overflow-y-auto space-y-4 mb-4">
                    <div v-if="carrito.length === 0" class="text-center text-gray-400 py-10">Vacío</div>
                    <div v-for="item in carritoDetalle" :key="item.id" class="flex justify-between items-center border-b border-gray-50 pb-2">
                        <div>
                            <div class="text-sm font-bold text-gray-800">{{ item.nombre }}</div>
                            <div class="text-xs text-gray-500">x{{ item.cantidad }}</div>
                        </div>
                        <button @click="eliminarDelCarrito(item.id)" class="text-red-400 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button @click="vaciarCarrito" class="flex-1 bg-red-50 text-red-600 py-3 rounded-xl font-bold text-sm">Vaciar</button>
                    <a href="carrito.html" class="flex-1 bg-brand-500 text-white py-3 rounded-xl font-bold text-sm text-center shadow-md">Ver Completo</a>
                </div>
            </div>
        </div>

        <div id="mensajeAgregado" :class="{'visible': toastVisible, 'error': toastIsError}">
            <i v-if="!toastIsError" data-lucide="check-circle" class="w-5 h-5 text-brand-400"></i>
            <i v-else data-lucide="alert-circle" class="w-5 h-5 text-red-300"></i>
            <span>{{ toastMensaje }}</span>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
        const API_URL = 'https://distribuidorafunaz-a2o6.onrender.com/api/productos';

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const loading = ref(true);
                const error = ref(null);
                const producto = ref(null);
                const cantidad = ref(1);
                const carrito = ref(JSON.parse(localStorage.getItem('carrito')) || []);
                const carritoAbierto = ref(false);
                const agregadoFeedback = ref(false);
                const toastVisible = ref(false);
                const toastMensaje = ref('');
                const toastIsError = ref(false);
                let toastTimeout = null;

                // --- HELPER STOCK LOGIC (IGUAL QUE EN INDEX) ---
                const calcularStockTotal = (p) => {
                    if (!p) return 0;
                    // 1. Agotado manual
                    if (p.stock <= -99) return 0;
                    
                    // 2. Stock Leo NULL/Vacio = Infinito
                    if (p.stock_leo === null || p.stock_leo === undefined || p.stock_leo === "") {
                        return 9999999;
                    }

                    // 3. Calculo
                    let miStock = p.stock > 0 ? p.stock : 0;
                    let leoStock = parseFloat(p.stock_leo) || 0;

                    // 4. Si leoStock es 1 o menor, cuenta como 0
                    if (leoStock <= 1) leoStock = 0;

                    return miStock + leoStock;
                };

                const cargarProducto = async () => {
                    const id = new URLSearchParams(window.location.search).get('id');
                    if (!id) {
                        error.value = "Producto no especificado.";
                        loading.value = false;
                        return;
                    }

                    try {
                        const res = await fetch(API_URL);
                        if (!res.ok) throw new Error("Error API");
                        const productos = await res.json();
                        producto.value = productos.find(p => String(p.id) === String(id));
                        
                        if (!producto.value) throw new Error("Producto no encontrado.");

                        // Cargar cantidad previa si ya estaba en carrito
                        const existente = carrito.value.find(p => String(p.id) === String(id));
                        if (existente) cantidad.value = existente.cantidad;

                    } catch (e) {
                        error.value = e.message;
                    } finally {
                        loading.value = false;
                    }
                };

                onMounted(() => {
                    cargarProducto();
                    lucide.createIcons();
                });

                // Computed
                const stockDisponible = computed(() => {
                    return calcularStockTotal(producto.value);
                });

                const precioFinal = computed(() => {
                    return producto.value ? Number(producto.value.precio) * 1.10 : 0;
                });

                const imagenUrl = computed(() => {
                    if (!producto.value || !producto.value.imagen) return `${SUPABASE_URL}/storage/v1/object/public/imagenes/placeholder.png`;
                    const clean = producto.value.imagen.replace(/^imagenes\//, '');
                    return `${SUPABASE_URL}/storage/v1/object/public/imagenes/${clean}`;
                });

                const cantidadTotalCarrito = computed(() => {
                    return carrito.value.reduce((acc, item) => acc + item.cantidad, 0);
                });

                const carritoDetalle = computed(() => {
                    return carrito.value.map(c => ({
                        ...c,
                        nombre: (producto.value && String(producto.value.id) === String(c.id)) ? producto.value.nombre : (c.nombre || 'Producto')
                    }));
                });

                // Actions
                const aumentar = () => { cantidad.value++; };
                const disminuir = () => { if (cantidad.value > 1) cantidad.value--; };
                
                const validarInput = () => {
                    if (cantidad.value < 1 || isNaN(cantidad.value)) cantidad.value = 1;
                };

                const agregarAlCarrito = () => {
                    if (!producto.value) return;

                    // VALIDACIÓN DE STOCK
                    const id = producto.value.id;
                    const stockMax = stockDisponible.value;
                    const existente = carrito.value.find(p => String(p.id) === String(id));
                    
                    // Cantidad que habría en total si agregamos lo que pide
                    let cantidadFutura = cantidad.value; // Por defecto asumimos que sobreescribe o es nuevo
                    
                    // Nota: En la lógica de "Detalle", generalmente el input 'cantidad' 
                    // representa la cantidad TOTAL deseada, no un "+1".
                    // Si la lógica fuera "sumar a lo que hay", sería: (existente ? existente.cantidad : 0) + cantidad.value;
                    // Pero en tu código anterior hacías `existente.cantidad = cantidad.value`, o sea, reemplazo.
                    // Mantendremos el reemplazo que es lo usual en página de detalle, pero validamos.

                    if (cantidadFutura > stockMax) {
                        mostrarToast(`Solo hay ${stockMax} disponibles.`, true);
                        return;
                    }

                    if (existente) {
                        existente.cantidad = cantidad.value;
                    } else {
                        carrito.value.push({
                            id: producto.value.id,
                            nombre: producto.value.nombre,
                            cantidad: cantidad.value
                        });
                    }

                    localStorage.setItem('carrito', JSON.stringify(carrito.value));
                    
                    // Feedback Visual
                    agregadoFeedback.value = true;
                    if (navigator.vibrate) navigator.vibrate(50);
                    setTimeout(() => agregadoFeedback.value = false, 1500);

                    // Toast Exito
                    mostrarToast(`${producto.value.nombre} (x${cantidad.value})`, false);
                };

                const mostrarToast = (msg, esError = false) => {
                    toastMensaje.value = esError ? msg : "Guardado: " + msg;
                    toastIsError.value = esError;
                    toastVisible.value = true;
                    if(toastTimeout) clearTimeout(toastTimeout);
                    toastTimeout = setTimeout(() => toastVisible.value = false, 2500);
                };

                const eliminarDelCarrito = (id) => {
                    carrito.value = carrito.value.filter(i => String(i.id) !== String(id));
                    localStorage.setItem('carrito', JSON.stringify(carrito.value));
                    if (producto.value && String(producto.value.id) === String(id)) cantidad.value = 1;
                };

                const vaciarCarrito = () => {
                    if(confirm("¿Vaciar carrito?")) {
                        carrito.value = [];
                        localStorage.setItem('carrito', JSON.stringify(carrito.value));
                        cantidad.value = 1;
                    }
                };

                const toggleCarrito = () => { carritoAbierto.value = !carritoAbierto.value; };

                // Format Money
                const formatMoney = (v) => (v || 0).toLocaleString('es-AR', {minimumFractionDigits:2, maximumFractionDigits:2});

                return {
                    loading, error, producto, cantidad,
                    precioFinal, imagenUrl,
                    aumentar, disminuir, validarInput,
                    agregarAlCarrito, agregadoFeedback,
                    carritoAbierto, toggleCarrito,
                    cantidadTotalCarrito, carritoDetalle,
                    eliminarDelCarrito, vaciarCarrito,
                    toastVisible, toastMensaje, toastIsError,
                    formatMoney, stockDisponible // Exportamos para usar en template
                };
            },
            updated() { lucide.createIcons(); }
        }).mount('#app');
    </script>
</body>
</html>
