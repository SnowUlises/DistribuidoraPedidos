<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Distribuidora Funaz</title>
  
  <link id="faviconLink" rel="icon" type="image/png" href="" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: { 400: '#a3e635', 500: '#84cc16', 600: '#65a30d', 900: '#3f6212' },
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1f2937; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
    
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }

    #mensajeCarrito {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px);
        background: #1f2937; color: white; padding: 12px 24px; border-radius: 50px;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); font-weight: 600; font-size: 0.9em;
        z-index: 2000; opacity: 0; pointer-events: none;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; align-items: center; gap: 8px; width: max-content; max-width: 90%;
    }
    #mensajeCarrito.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    #carritoContainer {
        position: fixed; top: 70px; right: 20px; width: 320px; max-height: 80vh;
        background: #fff; border-radius: 16px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2);
        overflow-y: auto; display: none; z-index: 1500; padding: 20px; border: 1px solid #e5e7eb;
    }
    
    @media (max-width: 768px) {
        #carritoContainer {
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-height: 70vh; right: auto;
        }
    }

    .productos-grid {
        display: grid; gap: 16px;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
    }
    
    @media (max-width: 640px) {
        .productos-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
    }

    .cat-active {
        background-color: #a3e635 !important;
        color: #1a2e05 !important;
        font-weight: 700;
        box-shadow: 0 4px 6px -1px rgba(163, 230, 53, 0.3);
    }
  </style>
</head>
<body>

  <header class="bg-white sticky top-0 z-50 border-b border-gray-100 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center">
            <img id="logoImg" src="" alt="Distribuidora Funaz" class="h-16 w-auto object-contain block"> 
        </div>

        <div class="header-buttons flex items-center gap-2">
            <a id="btnUsuario" href="login.html" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1.5 transition-colors">
                <i data-lucide="user" class="w-4 h-4"></i> <span>Ingresar</span>
            </a>
            
            <button id="btnCarrito" class="bg-brand-500 hover:bg-brand-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-1.5 shadow-sm shadow-brand-200 transition-all active:scale-95">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i> <span>(0)</span>
            </button>
        </div>
    </div>
  </header>

  <div id="carritoContainer">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-900 flex items-center gap-2"><i data-lucide="shopping-bag" class="text-brand-500 w-5 h-5"></i> Tu Carrito</h3>
        <button onclick="toggleCarrito()" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    
    <div id="itemsCarrito" class="space-y-2 mb-4 max-h-[40vh] overflow-y-auto"></div>

    <div class="flex gap-2">
      <button onclick="vaciarCarrito()" class="flex-1 bg-red-50 hover:bg-red-100 text-red-600 py-2 rounded-lg text-xs font-bold transition-colors">Vaciar</button>
      <button onclick="verCarrito()" class="flex-1 bg-brand-500 hover:bg-brand-600 text-white py-2 rounded-lg text-xs font-bold shadow-sm transition-colors">Ver Detalle</button>
    </div>
  </div>

  <div class="max-w-7xl mx-auto flex flex-col md:flex-row gap-6 p-4">
    
    <aside class="w-full md:w-64 flex-shrink-0 sticky top-[85px] z-40 bg-f8fafc md:bg-transparent pb-2 md:pb-0 overflow-x-auto hide-scroll -mx-4 px-4 md:mx-0 md:px-0">
      <h2 class="hidden md:block text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 pl-1">Categor√≠as</h2>
      <ul id="listaCategorias" class="flex md:flex-col gap-2 md:gap-1">
        <li class="cat-active whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('Todos', this)">Todos</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('ALIMENTOS', this)">Alimentos</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('BEBIDAS', this)">Bebidas</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('ACCESORIOS', this)">Accesorios</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('LIMPIEZA', this)">Limpieza</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('PERFUMERIA', this)">Perfumeria</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('ANALGESICOS', this)">Analgesicos</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('ENCENDEDORES', this)">Encendedores</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('CREMAS', this)">Cremas</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('DESODORANTES', this)">Desodorantes</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('GALLETAS Y GOLOSINAS', this)">Galletas</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('JUGOS', this)">Jugos</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('PAPELES Y BOLSAS', this)">Papeles</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('PEGAMENTOS', this)">Pegamentos</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('REPELENTES', this)">Repelentes</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('SHAMPO Y ENJUAGUE', this)">Shampo</li>
        <li class="whitespace-nowrap cursor-pointer px-4 py-2 md:py-2.5 rounded-full md:rounded-lg text-sm bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 transition-all" onclick="filtrarCategoria('TINTURAS NANTYR', this)">Tinturas</li>
      </ul>
    </aside>

    <main class="flex-1 w-full">
      
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
        
        <div class="relative w-full md:w-1/2">
            <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
            <input id="buscador" type="search" placeholder="Buscar productos..." class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition-all">
        </div>

        <div class="flex gap-3 w-full md:w-auto justify-between md:justify-end">
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-gray-400 uppercase hidden sm:inline">Ordenar:</span>
                <select id="orden" onchange="renderProductos()" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:border-brand-500 block p-2 outline-none">
                    <option value="nombre">Nombre</option>
                    <option value="precioAsc">Precio: Menor a Mayor</option>
                    <option value="precioDesc">Precio: Mayor a Menor</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-gray-400 uppercase hidden sm:inline">Ver:</span>
                <select id="cantidadPagina" onchange="cambiarCantidadPagina()" class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:border-brand-500 block p-2 outline-none">
                    <option value="9">9</option>
                    <option value="16">16</option>
                    <option value="25" selected>25</option>
                </select>
            </div>
        </div>
      </div>

      <div class="productos productos-grid"></div>
      
      <div class="paginacion flex justify-center items-center gap-4 mt-8 pb-8">
        <button onclick="paginaAnterior()" id="btnPrev" class="bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-colors">‚Üê Anterior</button>
        <span id="infoPagina" class="text-sm font-medium text-gray-500"></span>
        <button onclick="paginaSiguiente()" id="btnNext" class="bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Siguiente ‚Üí</button>
      </div>

    </main>
  </div>

  <div id="mensajeCarrito">
      <i data-lucide="check-circle" class="w-5 h-5 text-brand-400"></i>
      <span>Producto Agregado</span>
  </div>

  <footer class="text-center py-6 text-xs text-gray-400 border-t border-gray-200 mt-auto bg-white">
    <div class="font-bold text-gray-500 mb-1">Distribuidora Funaz</div>
    <div>¬© 2025 - Todos los derechos reservados</div>
  </footer>

<script>
// CONFIGURACI√ìN SUPABASE
const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscm95Y3hpZndlenRoZG9ta255Iiwicm9sZSI6InFub24iLCJpYXQiOjE3NTYyNzIzNDIsImV4cCI6MjA3MTg0ODM0Mn0.OhgCTvtvdvOejXS9iXPX8rkg3Dh_jBkWObwhL-HnDB8'; 
const options = {
  auth: {
    persistSession: true, // Guarda la sesi√≥n en localStorage
    autoRefreshToken: true, // Renueva el token autom√°ticamente antes de que expire
    detectSessionInUrl: true // Detecta enlaces de login m√°gicos
  }
};

const _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, options);
window.supabase = _sb;

let productos = [];
let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
let categoriaSeleccionada = 'Todos';
let paginaActual = 1;
let cantidadPorPagina = 9;
let terminoBusqueda = '';

lucide.createIcons();

// --- L√ìGICA DE USUARIO ---
async function checkUser() {
    const btn = document.getElementById('btnUsuario');
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        btn.innerHTML = '<i data-lucide="user-check" class="w-4 h-4 text-brand-600"></i> <span>Mi Cuenta</span>';
        btn.href = 'mi-cuenta.html';
        btn.classList.add('bg-brand-50', 'text-brand-700', 'border', 'border-brand-200');
        btn.classList.remove('bg-gray-100', 'text-gray-700');
    } else {
        btn.innerHTML = '<i data-lucide="user" class="w-4 h-4"></i> <span>Ingresar</span>';
        btn.href = 'login.html';
    }
    lucide.createIcons();
}

_sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_OUT') {
        window.location.href = 'login.html'; 
    }
    if (event === 'TOKEN_REFRESHED') {
        console.log('Token renovado con √©xito, la sesi√≥n sigue viva.');
    }
});
  
function toggleCarrito() {
  const c = document.getElementById('carritoContainer');
  c.style.display = c.style.display === 'block' ? 'none' : 'block';
  renderCarrito();
}

function verCarrito() {
  if (carrito.length === 0) {
    alert('El carrito est√° vac√≠o.');
  } else {
    location.href = 'carrito.html'; 
  }
}

document.getElementById('btnCarrito').addEventListener('click', toggleCarrito);

async function cargarProductos() {
  try {
    const res = await fetch('https://distribuidorafunaz-a2o6.onrender.com/api/productos');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    
    // Actualizamos la variable global
    productos = data;
    console.log('Stock actualizado. Total productos:', productos.length);
    
    // Volvemos a renderizar solo si ya hay productos mostr√°ndose (para actualizar estados de "Agotado")
    // Esto es √∫til cuando el setInterval corre en background.
    if (document.querySelector('.productos').innerHTML !== '') {
        renderProductos();
    } else {
        cambiarCantidadPagina(); // Primera carga
    }
    
  } catch (err) {
    console.error('Error cargando productos:', err);
    // No mostramos alert en el setInterval para no molestar
  }
}

// EXPONER PARA TESTEO DESDE CONSOLA
// Escribe window.forceRefresh() en la consola
window.forceRefresh = function() {
    console.log("üîÑ Forzando recarga de productos...");
    cargarProductos();
};

function filtrarCategoria(categoria, elemento) {
  categoriaSeleccionada = categoria;
  document.querySelectorAll('#listaCategorias li').forEach(li => li.classList.remove('cat-active'));
  elemento.classList.add('cat-active');
  
  if(window.innerWidth < 768) {
    elemento.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }

  paginaActual = 1;
  renderProductos();
}

function cambiarCantidadPagina() {
  const sel = document.getElementById('cantidadPagina');
  cantidadPorPagina = parseInt(sel.value);
  paginaActual = 1;
  renderProductos();
}

function getImageUrl(fileName) {
  if (!fileName) return '';
  const cleanFileName = fileName.trim().replace(/^imagenes\//, '');
  return `https://slroycxifwezthdomkny.supabase.co/storage/v1/object/public/imagenes/${cleanFileName}`;
}

// --- HELPER PARA CALCULAR STOCK TOTAL ---
function calcularStockTotal(p) {
    // Regla 1: Si tu stock es -99 (Agotado manual), gana sobre todo lo dem√°s.
    if (p.stock <= -99) return 0;
    
    // Regla 2: Si stock_leo es null, undefined o "", lo consideramos INFINITO.
    // Retornamos un n√∫mero absurdamente alto.
    if (p.stock_leo === null || p.stock_leo === undefined || p.stock_leo === "") {
        return 9999999;
    }
    
    // Regla 3: Si hay n√∫mero, sumamos normal.
    let miStock = p.stock > 0 ? p.stock : 0;
    let leoStock = parseFloat(p.stock_leo) || 0;

    if (leoStock <= 1) {
        leoStock = 0;
    }
    
    return miStock + leoStock;
}

// FUNCION RENDER PRODUCTOS
function renderProductos() {
  const cont = document.querySelector('.productos');
  cont.innerHTML = '';
  let filtrados = productos;
  if (categoriaSeleccionada !== 'Todos') {
    filtrados = productos.filter(p => p.categoria === categoriaSeleccionada);
  }
  const orden = document.getElementById('orden').value;
  if (orden === 'nombre') {
    filtrados.sort((a,b) => a.nombre.localeCompare(b.nombre));
  } else if (orden === 'precioAsc') {
    filtrados.sort((a,b) => a.precio - b.precio);
  } else if (orden === 'precioDesc') {
    filtrados.sort((a,b) => b.precio - a.precio);
  }
  if (terminoBusqueda) {
    filtrados = filtrados.filter(p => {
      const nombre = (p.nombre || '').toString().toLowerCase();
      const desc = (p.descripcion || '').toString().toLowerCase();
      return nombre.includes(terminoBusqueda) || desc.includes(terminoBusqueda);
    });
  }
  const totalPaginas = Math.ceil(filtrados.length / cantidadPorPagina);
  if(paginaActual > totalPaginas) paginaActual = totalPaginas || 1;
  const inicio = (paginaActual -1) * cantidadPorPagina;
  const fin = inicio + cantidadPorPagina;
  const productosPagina = filtrados.slice(inicio, fin);
  
  productosPagina.forEach(p => {
    const div = document.createElement('div');
    // CLASES TAILWIND TARJETA
    div.className = 'bg-white rounded-xl border border-gray-100 p-4 flex flex-col justify-between items-center shadow-sm hover:shadow-md transition-all h-full relative group';
    
    let accionHTML = '';
    const itemEnCarrito = carrito.find(i => String(i.id) === String(p.id));
    const cantidadEnCarrito = itemEnCarrito ? itemEnCarrito.cantidad : 0;
    
    let btnTexto = "Agregar";
    let btnClase = "bg-gray-900 hover:bg-black text-white w-full py-2 rounded-lg text-sm font-bold transition-all active:scale-95";
    
    if(cantidadEnCarrito > 0) {
        btnTexto = `En carrito (${cantidadEnCarrito})`;
        btnClase = "bg-brand-500 hover:bg-brand-600 text-white w-full py-2 rounded-lg text-sm font-bold transition-all border border-brand-500 shadow-sm shadow-brand-200";
    }

    // --- NUEVA L√ìGICA DE VISUALIZACI√ìN DE STOCK ---
    const stockTotal = calcularStockTotal(p);
    
    // Solo mostramos Agotado si realmente es 0 (bloqueado manualmente o suma da 0)
    const esAgotado = (stockTotal <= 0);

    if (esAgotado) {
      accionHTML = '<div class="w-full text-center py-1.5 bg-red-50 text-red-500 text-xs font-bold rounded-lg uppercase tracking-wide">Agotado</div>';
    } else {
      accionHTML = `<button class="btn-carrito ${btnClase}" onclick="agregarAlCarrito(${p.id}, 1, false, this)">${btnTexto}</button>`;
    }
    
    const img = document.createElement('img');
    img.alt = p.nombre;
    img.className = 'w-24 h-24 object-contain mb-3 bg-gray-50 rounded-lg p-2';
    img.src = getImageUrl('placeholder.png');
    if (p.imagen) {
      const publicUrl = getImageUrl(p.imagen);
      if (publicUrl) {
        const realImg = new Image();
        realImg.src = publicUrl;
        realImg.onload = () => { img.src = publicUrl; };
        realImg.onerror = () => { img.src = getImageUrl('placeholder.png'); };
      }
    }
    
    div.innerHTML = `
      <h3 class="text-sm font-semibold text-gray-800 text-center mb-1 line-clamp-2 h-10 w-full leading-tight">${p.nombre}</h3>
      <div class="text-lg font-bold text-brand-600 mb-3">$${(p.precio * 1.10 * 1.02).toFixed(2)}</div>
      ${accionHTML}
    `;
    div.insertBefore(img, div.firstChild);
    
    div.onclick = (event) => {
      if (!event.target.classList.contains('btn-carrito')) {
        window.location.href = `producto.html?id=${p.id}`;
      }
    };
    cont.appendChild(div);
  });
  
  document.getElementById('infoPagina').textContent = `P√°gina ${paginaActual} de ${totalPaginas || 1}`;
  document.getElementById('btnPrev').disabled = paginaActual === 1;
  document.getElementById('btnNext').disabled = paginaActual === totalPaginas || totalPaginas === 0;
}

function paginaAnterior() {
  if (paginaActual > 1) {
    paginaActual--;
    renderProductos();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}
function paginaSiguiente() {
  const totalPaginas = Math.ceil((categoriaSeleccionada === 'Todos' ? productos.length : productos.filter(p => p.categoria === categoriaSeleccionada).length) / cantidadPorPagina);
  if (paginaActual < totalPaginas) {
    paginaActual++;
    renderProductos();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

// FUNCION AGREGAR (CON VALIDACI√ìN DE STOCK COMBINADO)
function agregarAlCarrito(id, cantidad = 1, silent = false, btnElement = null) {
  const producto = productos.find(p => String(p.id) === String(id));

  if (!producto) { return; }

  // 1. Chequeo manual de -99
  if (producto.stock <= -99) {
    mostrarMensaje('Producto sin stock.', true);
    return;
  }
  
  // 2. Chequeo de Stock Combinado
  const stockDispo = calcularStockTotal(producto);
  const item = carrito.find(i => i.id === id);
  const cantidadEnCarrito = item ? item.cantidad : 0;
  
  // Si lo que ya tengo + lo que quiero agregar supera lo disponible
  if ((cantidadEnCarrito + cantidad) > stockDispo) {
      mostrarMensaje(`Solo quedan ${stockDispo} disponibles.`, true);
      return;
  }

  // Si pasa, agregamos
  let nuevaCantidad = cantidad;

  if (item) {
      item.cantidad += cantidad;
      nuevaCantidad = item.cantidad;
  } else {
      carrito.push({ id, cantidad });
      nuevaCantidad = cantidad;
  }
  
  localStorage.setItem('carrito', JSON.stringify(carrito));
  
  if (btnElement) {
    btnElement.innerText = `En carrito (${nuevaCantidad})`;
    btnElement.className = "btn-carrito bg-brand-500 text-white w-full py-2 rounded-lg text-sm font-bold transition-all border border-brand-500 shadow-sm shadow-brand-200 transform scale-95";
    
    if (navigator.vibrate) navigator.vibrate(50);
    
    setTimeout(() => { btnElement.classList.remove('scale-95'); }, 150);
  }
  
  actualizarContadorCarrito();
  
  const btnHeader = document.getElementById('btnCarrito');
  btnHeader.classList.add('scale-110', 'bg-brand-400');
  setTimeout(() => btnHeader.classList.remove('scale-110', 'bg-brand-400'), 200);

  if (!silent) {
    mostrarMensaje(`<span class="font-bold text-brand-400">${producto.nombre}</span>: Llevas ${nuevaCantidad} un.`);
  }
  renderCarrito();
}

function actualizarContadorCarrito() {
  const total = carrito.reduce((acc, i) => acc + i.cantidad, 0);
  document.querySelector('#btnCarrito span').textContent = `(${total})`;
}

function renderCarrito() {
  const cont = document.getElementById('itemsCarrito');
  cont.innerHTML = '';
  if(carrito.length === 0){
    cont.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">El carrito est√° vac√≠o.</p>';
    return;
  }
  carrito.forEach(item => {
    const prod = productos.find(p => String(p.id) === String(item.id));
    if (!prod) return;
    const div = document.createElement('div');
    div.className = 'flex justify-between items-center p-2 border-b border-gray-50 text-sm';
    div.innerHTML = `
      <span class="text-gray-700">${prod.nombre} <b class="text-brand-600 bg-brand-50 px-1.5 rounded ml-1">x${item.cantidad}</b></span>
      <button onclick="eliminarDelCarrito(${item.id})" class="text-gray-300 hover:text-red-500 transition-colors p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
    `;
    cont.appendChild(div);
  });
  lucide.createIcons();
}

function eliminarDelCarrito(id) {
  carrito = carrito.filter(i => i.id !== id);
  localStorage.setItem('carrito', JSON.stringify(carrito));
  actualizarContadorCarrito();
  renderCarrito();
  renderProductos(); 
}

function vaciarCarrito() {
  if(confirm('¬øVaciar todo el carrito?')){
    carrito = [];
    localStorage.setItem('carrito', JSON.stringify(carrito));
    actualizarContadorCarrito();
    renderCarrito();
    renderProductos(); 
    toggleCarrito();
  }
}

let mensajeTimeout = null;
function mostrarMensaje(texto, error = false) {
  const m = document.getElementById('mensajeCarrito');
  const icon = error ? '<i data-lucide="alert-circle" class="text-red-400 w-5 h-5"></i>' : '<i data-lucide="check-circle" class="text-brand-400 w-5 h-5"></i>';
  m.innerHTML = `${icon} <span>${texto}</span>`;
  if(error) m.style.background = "#7f1d1d";
  else m.style.background = "#1f2937";
  m.classList.add('visible');
  lucide.createIcons();
  if (mensajeTimeout) clearTimeout(mensajeTimeout);
  mensajeTimeout = setTimeout(() => {
    m.classList.remove('visible');
    mensajeTimeout = null;
  }, 2500);
}

function keepAlive() { console.log(""); }
setInterval(keepAlive, 30000);

// Init
actualizarContadorCarrito();
cargarProductos();
checkUser(); 

// --- ACTUALIZACI√ìN DE STOCK EN SEGUNDO PLANO ---
// Se ejecuta cada 10 minutos (600,000 ms) para traer los datos nuevos del servidor
// sin que el usuario tenga que recargar la p√°gina.
setInterval(() => {
    console.log("Actualizando stock en segundo plano...");
    cargarProductos();
}, 600000);

const buscadorInput = document.getElementById('buscador');
if (buscadorInput) {
  buscadorInput.addEventListener('input', (e) => {
    terminoBusqueda = e.target.value.trim().toLowerCase();
    paginaActual = 1;
    renderProductos();
  });
}
const logoImg = document.getElementById('logoImg');
logoImg.src = getImageUrl('logo.png');
const faviconLink = document.getElementById('faviconLink');
faviconLink.href = getImageUrl('icono.png');
</script>
</body>
</html>



