<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logística</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: #f5f5f5; color: #1f1f1f; overflow: hidden; }
        
        #map { width: 100%; height: 100%; z-index: 1; }
        .leaflet-control-attribution, .leaflet-control-zoom { display: none !important; }

        /* UI SUPERIOR */
        .top-ui { position: absolute; top: 16px; left: 16px; right: 16px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .search-bar { background: white; border-radius: 12px; height: 48px; display: flex; align-items: center; padding: 0 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); pointer-events: auto; cursor: pointer; transition: 0.1s; }
        .search-bar:active { transform: scale(0.98); }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 2000; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { background: white; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; }
        .sidebar-title { font-size: 18px; font-weight: 700; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }

        /* GRUPOS EN SIDEBAR */
        .group-section { background: white; border-radius: 12px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 2px solid transparent; transition: 0.2s; }
        .group-section.sortable-drag { opacity: 0.5; }
        .group-header { padding: 12px 15px; display: flex; align-items: center; gap: 10px; background: #fff; border-bottom: 1px solid #f0f0f0; }
        
        .group-color-dot { width: 14px; height: 14px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); flex-shrink: 0; }
        .group-name-input { border: none; font-size: 14px; font-weight: 700; color: #333; flex: 1; background: transparent; }
        .group-actions { opacity: 0.3; transition: 0.2s; cursor: pointer; }
        .group-header:hover .group-actions { opacity: 1; }

        .items-container { min-height: 10px; padding: 0; }
        
        /* ITEMS DE DIRECCION */
        .place-item { padding: 12px 15px; background: white; border-bottom: 1px solid #f5f5f5; cursor: grab; display: flex; align-items: center; justify-content: space-between; user-select: none; }
        .place-item:active { cursor: grabbing; }
        .place-item:last-child { border-bottom: none; }
        .place-info { flex: 1; }
        .place-title { font-size: 14px; font-weight: 500; color: #202124; }
        .place-notes { font-size: 12px; color: #70757a; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .drag-handle { color: #ccc; margin-left: 10px; cursor: grab; }

        /* COLOR PICKER POPUP */
        .color-picker-pop { position: absolute; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; gap: 8px; flex-wrap: wrap; width: 140px; z-index: 3000; display: none; }
        .cp-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .cp-dot:hover { transform: scale(1.1); }

        /* FABs */
        .fab-container { position: absolute; bottom: 32px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }
        .fab { width: 56px; height: 56px; background: #1a1a1a; border-radius: 18px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 6px 16px rgba(0,0,0,0.3); cursor: pointer; transition: 0.2s; }
        .fab-mini { width: 48px; height: 48px; background: white; color: #555; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }

        /* UI AGREGAR */
        #center-pin-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 900; pointer-events: none; display: none; flex-direction: column; align-items: center; }
        .confirm-btn-float { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: #1a1a1a; color: white; padding: 14px 28px; border-radius: 30px; font-weight: 600; font-size: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1001; cursor: pointer; display: none; }

        /* SHEET */
        .sheet-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; opacity: 0; pointer-events: none; transition: 0.3s; }
        .sheet-overlay.open { opacity: 1; pointer-events: auto; }
        .sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 24px 24px 0 0; z-index: 1002; transform: translateY(105%); transition: 0.3s; padding-bottom: 30px; max-height: 85vh; overflow-y: auto; }
        .sheet.open { transform: translateY(0); }
        .sheet-body { padding: 20px; }
        
        .modern-input { width: 100%; padding: 12px; background: #f1f3f4; border: none; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 5px; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-danger { background: #fce8e6; color: #c5221f; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="top-ui">
        <div class="search-bar" id="btn-menu">
            <i class="fa-solid fa-bars" style="margin-right:12px; color:#5f6368"></i>
            <span style="font-weight:600; color:#3c4043">Mis Direcciones</span>
        </div>
    </div>

    <div id="center-pin-container">
        <i class="fa-solid fa-location-dot" style="font-size:44px; color:#ea4335; filter:drop-shadow(0 4px 4px rgba(0,0,0,0.3))"></i>
    </div>
    <div class="confirm-btn-float" id="btn-confirm-pos">Confirmar</div>

    <div class="fab-container">
        <div class="fab-mini" id="btn-gps" title="Mi Ubicación"><i class="fa-solid fa-location-crosshairs"></i></div>
        <div class="fab" id="btn-add-mode"><i class="fa-solid fa-plus"></i></div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Mis Lugares</span>
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="btn-new-group" style="font-size:13px; font-weight:600; color:#1a73e8; cursor:pointer; background:#e8f0fe; padding:6px 12px; border-radius:20px;">
                    + Grupo
                </div>
                <i class="fa-solid fa-xmark" onclick="toggleSidebar()" style="font-size:20px; cursor:pointer; color:#5f6368;"></i>
            </div>
        </div>
        
        <div class="sidebar-content" id="sidebar-content">
            </div>
    </div>

    <div class="color-picker-pop" id="color-picker"></div>

    <div class="sheet-overlay" id="overlay"></div>
    <div class="sheet" id="sheet">
        <div class="sheet-body">
            <div id="view-form" style="display:none;">
                <h2 id="form-title">Nueva Dirección</h2>
                <input type="text" id="inp-name" class="modern-input" placeholder="Nombre (ej. Casa Juan)">
                <input type="text" id="inp-notes" class="modern-input" placeholder="Notas">
                <input type="text" id="inp-link" class="modern-input" placeholder="Link Maps (Opcional)">
                <button id="btn-save" class="btn btn-primary">Guardar</button>
            </div>
            <div id="view-details" style="display:none;">
                <h2 id="txt-title" style="margin-bottom:5px;"></h2>
                <p id="txt-desc" style="color:#666; margin-bottom:20px;"></p>
                <a id="btn-gmaps" href="#" target="_blank" class="btn btn-primary" style="display:flex; justify-content:center; text-decoration:none; align-items:center; gap:8px;">
                    <i class="fa-solid fa-map-location-dot"></i> Ir a Maps
                </a>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button id="btn-edit" class="btn" style="background:#f1f3f4; color:#333;">Editar</button>
                    <button id="btn-delete" class="btn btn-danger">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loader"><div>Cargando...</div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = 'https://distribuidorafunaz-a2o6.onrender.com';
        const COLORS = ['#d93025', '#1a73e8', '#1e8e3e', '#f9ab00', '#9334e6', '#e37400', '#00897b', '#e91e63'];
        
        let map, markers=[], locations=[], isAdding=false, token, myId;
        let currentLoc = null, holdTimer;

        // AUTH
        function getSession() {
            for(let i=0; i<localStorage.length; i++) {
                let k = localStorage.key(i);
                if(k.startsWith('sb-') && k.endsWith('-auth-token')) return JSON.parse(localStorage.getItem(k));
            }
            return null;
        }

        async function api(path, method='GET', data=null) {
            const opts = { method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } };
            if(data) opts.body = JSON.stringify(data);
            const res = await fetch(`${API_URL}${path}`, opts);
            if(res.status === 401) { localStorage.clear(); window.location.href='login.html'; }
            return res.json();
        }

        async function init() {
            const s = getSession();
            if(!s) return window.location.href='login.html';
            token = s.access_token; myId = s.user.id;
            document.getElementById('loader').style.display='none';
            initMap();
            loadData();
        }

        // MAPA
        function initMap() {
            map = L.map('map', {zoomControl:false}).setView([-31.5375, -68.5364], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

            // Long Press
            map.on('mousedown touchstart', (e) => {
                if(isAdding || document.getElementById('sheet').classList.contains('open')) return;
                holdTimer = setTimeout(() => {
                    navigator.vibrate?.(50);
                    openFormNew(e.latlng);
                }, 800); 
            });
            map.on('mouseup touchend dragstart', () => clearTimeout(holdTimer));
        }

        async function loadData() {
            try { 
                locations = await api('/api/direcciones') || []; 
                renderMap();
                renderSidebar();
            } catch(e){}
        }

        function renderMap() {
            markers.forEach(m => map.removeLayer(m)); markers=[];
            locations.forEach(loc => {
                const color = loc.group_color || '#d93025';
                const icon = L.divIcon({ className:'c-pin', html:`<div style="background:${color};width:16px;height:16px;border:3px solid white;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,0.4)"></div>`, iconSize:[24,24], iconAnchor:[12,12] });
                const m = L.marker([loc.lat, loc.lng], {icon}).addTo(map);
                m.on('click', () => { currentLoc=loc; openSheet('details'); map.flyTo([loc.lat, loc.lng], 16); });
                markers.push(m);
            });
        }

        // --- SIDEBAR & GRUPOS (Lógica Core) ---
        function renderSidebar() {
            const container = document.getElementById('sidebar-content');
            container.innerHTML = '';

            // 1. Agrupar datos
            const groupsMap = {};
            const noGroup = [];

            locations.forEach(loc => {
                if(loc.group_name) {
                    if(!groupsMap[loc.group_name]) groupsMap[loc.group_name] = { color: loc.group_color, items: [] };
                    groupsMap[loc.group_name].items.push(loc);
                } else {
                    noGroup.push(loc);
                }
            });

            // 2. Renderizar Secciones de Grupo
            Object.keys(groupsMap).forEach(gName => {
                const grp = groupsMap[gName];
                const section = createGroupSection(gName, grp.color, grp.items);
                container.appendChild(section);
            });

            // 3. Renderizar Sin Grupo
            const unGroupSection = createGroupSection(null, '#777', noGroup);
            container.appendChild(unGroupSection);

            // 4. Activar Sortable (Drag & Drop)
            initSortable();
        }

        function createGroupSection(name, color, items) {
            const sec = document.createElement('div');
            sec.className = 'group-section';
            sec.dataset.gname = name || ''; // Dataset para saber destino al soltar
            sec.dataset.gcolor = color || '#777';

            // Header (Editable solo si es grupo)
            const header = document.createElement('div');
            header.className = 'group-header';
            
            if(name) {
                // Color Dot
                const dot = document.createElement('div');
                dot.className = 'group-color-dot';
                dot.style.background = color;
                dot.onclick = (e) => showColorPicker(e, name);
                
                // Nombre Input
                const input = document.createElement('input');
                input.className = 'group-name-input';
                input.value = name;
                input.onblur = (e) => renameGroup(name, e.target.value);
                
                // Borrar Grupo
                const trash = document.createElement('i');
                trash.className = 'fa-solid fa-trash group-actions';
                trash.style.color = '#ccc';
                trash.onclick = () => deleteGroup(name);

                header.append(dot, input, trash);
            } else {
                header.innerHTML = `<span style="font-size:12px; font-weight:700; color:#999;">SIN AGRUPAR</span>`;
            }
            
            const list = document.createElement('div');
            list.className = 'items-container';
            
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'place-item';
                row.dataset.id = item.id;
                row.innerHTML = `
                    <div class="place-info" onclick="jumpTo(${item.lat},${item.lng}, '${item.id}')">
                        <div class="place-title">${item.name}</div>
                        <div class="place-notes">${item.notes || ''}</div>
                    </div>
                    <i class="fa-solid fa-grip-lines drag-handle"></i>
                `;
                list.appendChild(row);
            });

            sec.append(header, list);
            return sec;
        }

        function initSortable() {
            const containers = document.querySelectorAll('.items-container');
            containers.forEach(c => {
                new Sortable(c, {
                    group: 'shared', // Permite mover entre listas
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: async (evt) => {
                        // Al soltar, calcular nuevo estado
                        saveReorder();
                    }
                });
            });
        }

        async function saveReorder() {
            const allItems = [];
            let globalIndex = 0;

            // Recorrer el DOM para ver cómo quedó todo
            document.querySelectorAll('.group-section').forEach(sec => {
                const gName = sec.dataset.gname || null;
                const gColor = sec.dataset.gcolor || '#d93025';
                
                sec.querySelectorAll('.place-item').forEach(row => {
                    allItems.push({
                        id: row.dataset.id,
                        position: globalIndex++,
                        group_name: gName,
                        group_color: gColor
                    });
                });
            });

            // Optimismo UI (Actualizar memoria local)
            locations.forEach(l => {
                const update = allItems.find(u => u.id === l.id);
                if(update) {
                    l.position = update.position;
                    l.group_name = update.group_name;
                    l.group_color = update.group_color; // Hereda color del grupo
                }
            });
            renderMap(); // Actualizar colores de pines

            // Guardar en Server
            await api('/api/reordenar-todo', 'PUT', { items: allItems });
        }

        // --- GESTIÓN GRUPOS ---
        document.getElementById('btn-new-group').onclick = () => {
            // Crea un grupo temporal en memoria agregando un item "placeholder" o simplemente renderizando
            // Truco: Para que persista, necesitamos al menos un item o manejar grupos vacios. 
            // Como el usuario dijo "arrastrar hacia esos grupos", crearemos una caja visual vacía en el DOM.
            const container = document.getElementById('sidebar-content');
            const newSec = createGroupSection('Nuevo Grupo', '#1a73e8', []);
            // Insertar antes de "Sin Agrupar"
            container.insertBefore(newSec, container.lastChild);
            initSortable(); // Re-bind drag events
        };

        async function renameGroup(oldName, newName) {
            if(oldName === newName) return;
            // Actualizar todos los items de ese grupo
            locations.forEach(l => { if(l.group_name === oldName) l.group_name = newName; });
            renderSidebar();
            await saveReorder();
        }

        async function deleteGroup(name) {
            if(!confirm('Se desagruparán los items. ¿Seguir?')) return;
            locations.forEach(l => { if(l.group_name === name) l.group_name = null; });
            renderSidebar();
            renderMap();
            await saveReorder();
        }

        function showColorPicker(e, groupName) {
            const cp = document.getElementById('color-picker');
            cp.style.display = 'flex';
            cp.style.top = e.clientY + 'px';
            cp.style.left = e.clientX + 'px';
            cp.innerHTML = '';
            
            COLORS.forEach(c => {
                const d = document.createElement('div'); d.className='cp-dot'; d.style.background=c;
                d.onclick = async () => {
                    locations.forEach(l => { if(l.group_name === groupName) l.group_color = c; });
                    renderSidebar(); renderMap(); cp.style.display='none';
                    await saveReorder();
                };
                cp.appendChild(d);
            });
            // Click outside closes
            setTimeout(() => document.addEventListener('click', closeCp), 0);
            function closeCp() { cp.style.display='none'; document.removeEventListener('click', closeCp); }
        }

        // --- GPS ---
        document.getElementById('btn-gps').onclick = () => {
            navigator.geolocation.getCurrentPosition(pos => map.flyTo([pos.coords.latitude, pos.coords.longitude], 16));
        };

        // --- FORMULARIOS ---
        function openFormNew(latlng) {
            currentLoc = null;
            document.getElementById('inp-name').value='';
            document.getElementById('inp-notes').value='';
            document.getElementById('inp-link').value='';
            // Guardar latlng en dataset
            document.getElementById('sheet').dataset.lat = latlng.lat;
            document.getElementById('sheet').dataset.lng = latlng.lng;
            openSheet('form');
        }

        function openSheet(view) {
            document.getElementById('sheet').classList.add('open');
            document.getElementById('overlay').classList.add('open');
            document.getElementById('view-form').style.display = view==='form'?'block':'none';
            document.getElementById('view-details').style.display = view==='details'?'block':'none';
            
            if(view==='details' && currentLoc) {
                document.getElementById('txt-title').innerText = currentLoc.name;
                document.getElementById('txt-desc').innerText = currentLoc.notes || '';
                document.getElementById('btn-gmaps').href = currentLoc.gmaps_link || '#';
            }
        }

        document.getElementById('btn-save').onclick = async () => {
            const body = {
                name: document.getElementById('inp-name').value,
                notes: document.getElementById('inp-notes').value,
                gmaps_link: document.getElementById('inp-link').value
            };
            if(!body.name) return;

            if(currentLoc) {
                await api(`/api/direcciones/${currentLoc.id}`, 'PUT', body);
            } else {
                const lat = parseFloat(document.getElementById('sheet').dataset.lat);
                const lng = parseFloat(document.getElementById('sheet').dataset.lng);
                await api('/api/direcciones', 'POST', { ...body, lat, lng });
            }
            closeSheet(); loadData();
        };

        document.getElementById('btn-delete').onclick = async () => {
            if(confirm('Borrar?')) { await api(`/api/direcciones/${currentLoc.id}`, 'DELETE'); closeSheet(); loadData(); }
        };
        document.getElementById('btn-edit').onclick = () => {
            document.getElementById('inp-name').value = currentLoc.name;
            document.getElementById('inp-notes').value = currentLoc.notes;
            document.getElementById('inp-link').value = currentLoc.gmaps_link;
            openSheet('form');
        };

        // UI Utils
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        document.getElementById('btn-menu').onclick = toggleSidebar;
        document.getElementById('overlay').onclick = closeSheet;
        document.getElementById('cancel-btn').onclick = closeSheet;
        function closeSheet() { document.getElementById('sheet').classList.remove('open'); document.getElementById('overlay').classList.remove('open'); }
        
        window.jumpTo = (lat, lng, id) => {
            currentLoc = locations.find(l => l.id === id);
            toggleSidebar();
            map.setView([lat, lng], 16);
            openSheet('details');
        };

        // Add Manual
        document.getElementById('btn-add-mode').onclick = () => {
            isAdding = !isAdding;
            const fab = document.getElementById('btn-add-mode');
            document.getElementById('center-pin-container').style.display = isAdding?'flex':'none';
            document.getElementById('btn-confirm-pos').style.display = isAdding?'block':'none';
            fab.innerHTML = isAdding ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-plus"></i>';
            if(isAdding) { fab.style.background='#d93025'; closeSheet(); } else fab.style.background='#1a1a1a';
        };
        document.getElementById('btn-confirm-pos').onclick = () => {
            const c = map.getCenter();
            document.getElementById('btn-add-mode').click();
            openFormNew(c);
        };

        init();
    </script>
</body>
</html>
