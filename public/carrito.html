<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Distribuidora Funaz</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 400: '#a3e635', 500: '#84cc16', 600: '#65a30d' },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1f2937; padding-bottom: 120px; }
        .mono-num { font-family: 'JetBrains Mono', monospace; }
        
        /* 2. TRUCO ANTI-PARPADEO (v-cloak) */
        /* Esto oculta las llaves {{ }} hasta que Vue esté listo */
        [v-cloak] { display: none !important; }

        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="app" v-cloak class="flex-1 max-w-3xl mx-auto w-full p-4 md:p-8">
        
        <header class="flex items-center justify-between mb-8">
            <a href="index.html" class="flex items-center gap-2 text-gray-600 hover:text-brand-600 transition-colors font-bold text-sm bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Seguir comprando
            </a>
            <h1 class="text-xl font-bold tracking-tight text-gray-900">Mi Carrito</h1>
            <div class="w-8"></div> 
        </header>

        <div v-if="loading" class="flex flex-col items-center justify-center py-20 text-gray-400">
            <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-3 text-brand-500"></i>
            <span class="text-xs font-bold uppercase tracking-widest text-gray-500">Cargando productos...</span>
        </div>

        <div v-else-if="carrito.length === 0" class="flex flex-col items-center justify-center py-20 text-center">
            <div class="bg-gray-100 p-6 rounded-full mb-4">
                <i data-lucide="shopping-cart" class="w-12 h-12 text-gray-400"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-900 mb-2">Tu carrito está vacío</h2>
            <p class="text-gray-500 text-sm mb-6 max-w-xs mx-auto">Parece que aún no has agregado nada.</p>
            <a href="index.html" class="bg-brand-500 hover:bg-brand-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-brand-200 transition-all hover:-translate-y-1">
                Ir a la Tienda
            </a>
        </div>

        <div v-else class="space-y-4 pb-24">
            <div v-for="(item, index) in itemsConDetalle" :key="item.id" class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex gap-4 items-center relative overflow-hidden group">
                <div class="w-20 h-20 bg-gray-50 rounded-lg flex-shrink-0 p-2 flex items-center justify-center border border-gray-100">
                    <img :src="item.imagenUrl" class="w-full h-full object-contain" alt="Producto" onerror="this.src='https://placehold.co/100x100?text=No+Img'">
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-gray-800 text-sm leading-tight mb-1 truncate">{{ item.nombre }}</h3>
                    <div class="text-xs text-gray-500 mb-2">{{ formatMoney(item.precioUnitario) }} c/u</div>
                    <div class="font-bold text-brand-600 mono-num">{{ formatMoney(item.subtotal) }}</div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200 p-1">
                        <button @click="restar(index)" class="w-8 h-8 flex items-center justify-center text-gray-600 hover:bg-white hover:shadow-sm rounded-md transition-all font-bold">-</button>
                        <span class="w-8 text-center font-bold text-sm text-gray-800">{{ item.cantidad }}</span>
                        <button @click="sumar(index)" class="w-8 h-8 flex items-center justify-center text-brand-600 hover:bg-white hover:shadow-sm rounded-md transition-all font-bold">+</button>
                    </div>
                    <button @click="eliminar(index)" class="text-xs text-red-400 hover:text-red-600 font-medium flex items-center gap-1 p-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>

        <transition name="slide-up">
            <div v-if="carrito.length > 0" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-40">
                <div class="max-w-3xl mx-auto flex flex-col gap-3">
                    <div class="flex justify-between items-end px-1">
                        <span class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total a Pagar</span>
                        <span class="text-2xl font-black text-gray-900 mono-num tracking-tight">{{ formatMoney(totalGeneral) }}</span>
                    </div>
                    <button @click="abrirModal" class="w-full bg-brand-500 hover:bg-brand-600 text-white py-3.5 rounded-xl font-bold text-lg shadow-lg shadow-brand-200 transition-all hover:-translate-y-0.5 active:scale-95 flex justify-center items-center gap-2">
                        Confirmar Pedido <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="modalAbierto" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative" @click.stop>
                    <button @click="cerrarModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 p-1">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>

                    <h3 class="text-xl font-bold text-gray-900 mb-2">Datos de Envío</h3>
                    <p class="text-sm text-gray-500 mb-6">Completa la información para finalizar.</p>

                    <form @submit.prevent="confirmarPedido" class="space-y-4">
                        
                        <div v-if="sesionActiva" class="bg-brand-50 border border-brand-200 rounded-xl p-3 mb-4 flex items-center gap-3">
                            <div class="bg-brand-200 p-2 rounded-full text-brand-700">
                                <i data-lucide="user" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <div class="text-[10px] text-brand-600 font-bold uppercase tracking-wider">Enviando como</div>
                                <div class="text-sm font-bold text-gray-800">{{ nombreUsuarioSesion }}</div>
                            </div>
                        </div>

                        <div v-if="!sesionActiva" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                                <input v-model="form.nombre" type="text" placeholder="Ej: Juan" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Apellido</label>
                                <input v-model="form.apellido" type="text" placeholder="Ej: Pérez" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all" required>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Negocio</label>
                            <input v-model="form.negocio" type="text" placeholder="Ej: Kiosco El Paso" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none transition-all" required>
                        </div>

                        <button type="submit" :disabled="enviando" class="w-full bg-brand-500 hover:bg-brand-600 disabled:bg-gray-300 disabled:text-gray-500 text-white py-3 rounded-xl font-bold shadow-md transition-all mt-4 flex justify-center items-center gap-2">
                            <span v-if="enviando">Enviando...</span>
                            <span v-else>Enviar Pedido</span>
                            <i v-if="!enviando" data-lucide="send" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscm95Y3hpZndlenRoZG9ta255Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjI3MjM0MiwiZXhwIjoyMDcxODQ4MzQyfQ.s7vfcg-sqZw-VxXUnOCyroi7oTyzfx0i4siNeDOW6lE';
        const API_BASE = 'https://distribuidorafunaz-a2o6.onrender.com/api';

        const { createApp, ref, computed, onMounted } = Vue;
        
        // 3. ASEGURAR CARGA DE LIBRERÍA
        if (typeof window.supabase === 'undefined') {
            alert("Error: No se pudo cargar el sistema. Por favor recarga la página.");
        }
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        createApp({
            setup() {
                const loading = ref(true);
                const productos = ref([]);
                const carrito = ref(JSON.parse(localStorage.getItem('carrito')) || []);
                const modalAbierto = ref(false);
                const enviando = ref(false);
                const sesionActiva = ref(false);
                const userId = ref(null);
                const currentUserData = ref(null);

                const form = ref({ nombre: '', apellido: '', negocio: '' });

                const cargarProductos = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/productos`);
                        if (!res.ok) throw new Error("Error API");
                        productos.value = await res.json();
                    } catch (e) { console.error(e); } finally { loading.value = false; }
                };

                onMounted(async () => {
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session) {
                            sesionActiva.value = true;
                            userId.value = session.user.id;
                            currentUserData.value = session.user;
                        }
                    } catch(e) { console.error("Error sesión", e); }
                    
                    await cargarProductos();
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                });

                const itemsConDetalle = computed(() => {
                    return carrito.value.map(item => {
                        const prod = productos.value.find(p => String(p.id) === String(item.id));
                        if (!prod) return null;
                        const precioUnitario = Number(prod.precio) * 1.10;
                        const imagenUrl = prod.imagen 
                            ? `${SUPABASE_URL}/storage/v1/object/public/imagenes/${prod.imagen.replace(/^imagenes\//, '')}`
                            : `${SUPABASE_URL}/storage/v1/object/public/imagenes/placeholder.png`;
                        return { ...item, nombre: prod.nombre, precioUnitario, subtotal: precioUnitario * item.cantidad, imagenUrl };
                    }).filter(Boolean);
                });

                const totalGeneral = computed(() => itemsConDetalle.value.reduce((acc, item) => acc + item.subtotal, 0));

                const nombreUsuarioSesion = computed(() => {
                    if (!currentUserData.value) return '';
                    const meta = currentUserData.value.user_metadata || {};
                    return meta.full_name || meta.name || currentUserData.value.email;
                });

                const guardarCarrito = () => localStorage.setItem('carrito', JSON.stringify(carrito.value));
                const sumar = (index) => { carrito.value[index].cantidad++; guardarCarrito(); };
                const restar = (index) => { if (carrito.value[index].cantidad > 1) carrito.value[index].cantidad--; else eliminar(index); guardarCarrito(); };
                const eliminar = (index) => { carrito.value.splice(index, 1); guardarCarrito(); };
                const abrirModal = () => { modalAbierto.value = true; };
                const cerrarModal = () => { modalAbierto.value = false; };

                const confirmarPedido = async () => {
                    enviando.value = true;
                    try {
                        let finalName = '';
                        if (sesionActiva.value && currentUserData.value) {
                            const meta = currentUserData.value.user_metadata || {};
                            finalName = meta.full_name || meta.name || currentUserData.value.email || 'Usuario Registrado';
                        } else {
                            finalName = `${form.value.nombre} ${form.value.apellido}`.trim();
                        }

                        const itemsEnviar = itemsConDetalle.value.map(item => ({
                            id: item.id, cantidad: item.cantidad, precio: item.precioUnitario
                        }));

                        const payload = {
                            nombre: finalName,
                            telefono: 'No solicitado',
                            items: itemsEnviar,
                            total: totalGeneral.value,
                            user_id: userId.value,
                            nombre_negocio: form.value.negocio
                        };

                        const res = await fetch(`${API_BASE}/Enviar-Peticion`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) throw new Error("Error al enviar");

                        carrito.value = [];
                        guardarCarrito();
                        cerrarModal();
                        alert("¡Pedido enviado con éxito!");
                        
                        if (sesionActiva.value) window.location.href = 'mi-cuenta.html';
                        else window.location.href = 'index.html';

                    } catch (e) {
                        alert("Error: " + e.message);
                    } finally {
                        enviando.value = false;
                    }
                };

                const formatMoney = (v) => (v || 0).toLocaleString('es-AR', {style:'currency', currency:'ARS'});

                return {
                    loading, carrito, itemsConDetalle, totalGeneral, modalAbierto, abrirModal, cerrarModal, sumar, restar, eliminar, form, confirmarPedido, enviando, sesionActiva, formatMoney, nombreUsuarioSesion
                };
            },
            updated() { if(typeof lucide !== 'undefined') lucide.createIcons(); }
        }).mount('#app');
    </script>
</body>
</html>
