<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Carrito - Distribuidora Funaz</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary-green: #2E7D32;
      --light-green: #4CAF50;
      --bg-color: #fcfdfc;
      --white: #ffffff;
      --danger: #e57373;
      --text-dark: #333;
      --text-grey: #666;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
      font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif; 
      margin: 0; 
      background: var(--bg-color); 
      color: var(--text-dark); 
      padding-bottom: 140px; /* Espacio para el footer flotante en movil */
    }

    /* HEADER SIMPLE */
    header {
      background: var(--primary-green);
      color: var(--white);
      padding: 1em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 1.2em; font-weight: 600; }
    
    .btn-volver {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.9em;
      font-weight: 500;
      display: flex; align-items: center; gap: 5px;
      border: none; cursor: pointer;
    }

    main { max-width: 800px; margin: auto; padding: 1.5em; }

    /* LISTA DE PRODUCTOS */
    #listaCarrito { display: flex; flex-direction: column; gap: 1em; }

    .producto-carrito {
      background: var(--white);
      border-radius: 16px;
      padding: 1em;
      display: flex;
      gap: 1em;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      border: 1px solid #f0f0f0;
      transition: transform 0.2s;
    }
    
    .producto-carrito img {
      width: 80px; height: 80px;
      object-fit: cover;
      border-radius: 12px;
      background: #f9f9f9;
      flex-shrink: 0;
    }

    .producto-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .producto-info h3 { margin: 0 0 5px 0; font-size: 1em; color: var(--text-dark); }
    .producto-info .precio-unit { font-size: 0.85em; color: var(--text-grey); }
    .producto-info .subtotal { font-weight: bold; color: var(--primary-green); margin-top: 4px; }

    /* CONTROLES CANTIDAD */
    .controles-cantidad {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }
    
    .stepper {
      display: flex;
      align-items: center;
      background: #f5f5f5;
      border-radius: 8px;
      padding: 3px;
    }
    .stepper button {
      width: 30px; height: 30px;
      background: var(--white); border: none;
      border-radius: 6px;
      font-weight: bold; color: var(--primary-green);
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .stepper span {
      width: 30px; text-align: center;
      font-weight: 600; font-size: 0.9em;
    }

    .btn-eliminar {
      background: none; border: none;
      color: #e57373; font-size: 0.85em;
      font-weight: 600; cursor: pointer;
      display: flex; align-items: center; gap: 4px;
      padding: 5px;
    }
    .btn-eliminar:hover { color: #c62828; }

    /* FOOTER FLOTANTE (RESUMEN) */
    .resumen-fixed {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--white);
      padding: 1.5em;
      border-top: 1px solid #eee;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
      z-index: 90;
      display: flex; flex-direction: column; gap: 10px;
      max-width: 800px; margin: 0 auto; /* Centrado en desktop */
    }

    .total-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1.2em; font-weight: bold; color: var(--text-dark);
    }
    .total-price { color: var(--primary-green); font-size: 1.3em; }

    button.enviar {
      background: var(--primary-green);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
      transition: background 0.2s;
    }
    button.enviar:hover { background: #1b5e20; }
    button.enviar:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

    /* FORMULARIO MODAL */
    #formOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      display: none; justify-content: center; align-items: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    #formDatos {
      background: var(--white);
      padding: 2em;
      border-radius: 20px;
      max-width: 400px; width: 90%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
      text-align: center;
    }
    
    #formDatos h3 { margin-top: 0; color: var(--primary-green); }
    
    #formDatos input {
      width: 100%; padding: 12px 15px; margin-bottom: 12px;
      border: 1px solid #ddd; border-radius: 10px;
      background: #f9f9f9; outline: none; transition: border 0.2s;
      font-size: 1em;
    }
    #formDatos input:focus { border-color: var(--light-green); background: white; }

    #btnCerrarFormulario {
      position: absolute; top: 15px; right: 15px;
      background: #f5f5f5; border: none;
      color: #666; border-radius: 50%;
      width: 32px; height: 32px;
      font-size: 1.2em; cursor: pointer;
    }

    /* ESTADO VACIO */
    .empty-cart {
      text-align: center;
      padding: 3em 1em;
      color: #999;
    }

    @media (min-width: 800px) {
      /* Ajustes PC */
      .resumen-fixed {
        position: static;
        border: 1px solid #eee; border-radius: 16px;
        margin-top: 2em;
        padding: 2em;
      }
      body { padding-bottom: 0; }
    }
  </style>
</head>
<body>
  
  <header>
    <button onclick="location.href='Index.html'" class="btn-volver">‚¨Ö Seguir comprando</button>
    <h1>Mi Pedido</h1>
    <div style="width:20px;"></div> </header>

  <main>
    <div id="listaCarrito"></div>
  </main>

  <div class="resumen-fixed">
    <div class="total-row">
      <span>Total:</span>
      <span class="total-price" id="totalCarrito">$0.00</span>
    </div>
    <button id="btnMostrarFormulario" class="enviar">Confirmar Pedido</button>
  </div>

  <div id="formOverlay">
    <div id="formDatos">
      <button type="button" id="btnCerrarFormulario">&times;</button>
      <h3>Datos de Env√≠o</h3>
      <p style="color:#666; font-size:0.9em; margin-bottom:1.5em;">Completa los datos para finalizar</p>
      
      <input type="text" id="negocio" placeholder="Nombre del Negocio (Ej: Kiosko Pepe)" required>
      
      <input type="text" id="nombre" placeholder="Tu Nombre (Ej: Juan)" required>
      <input type="text" id="apellido" placeholder="Tu Apellido" required>
      <input type="tel" id="telefono" placeholder="Tel√©fono" required>
      
      <button class="enviar" id="confirmarEnvio">Enviar Pedido</button>
      <div id="postActions"></div>
    </div>
  </div>

<script>
  // -----------------------------------------------------
  // ‚ö†Ô∏è CONFIGURACI√ìN DE SUPABASE (SIN ARCHIVOS EXTERNOS)
  // -----------------------------------------------------
  const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscm95Y3hpZndlenRoZG9ta255Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjI3MjM0MiwiZXhwIjoyMDcxODQ4MzQyfQ.s7vfcg-sqZw-VxXUnOCyroi7oTyzfx0i4siNeDOW6lE';

  // Inicializar Supabase
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  // -----------------------------------------------------

  let productos = [];
  let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

  const lista = document.getElementById('listaCarrito');
  const totalCarritoElem = document.getElementById('totalCarrito');
  const formOverlay = document.getElementById('formOverlay');
  const btnMostrarFormulario = document.getElementById('btnMostrarFormulario');
  const btnCerrarFormulario = document.getElementById('btnCerrarFormulario');
  const btnConfirmar = document.getElementById('confirmarEnvio');
  const postActions = document.getElementById('postActions');

  const apiBase = 'https://distribuidorafunaz-a2o6.onrender.com/api';

  // Obtener URL de imagen usando la variable global SUPABASE_URL
  function getImageUrl(fileName) {
    if (!fileName) return '';
    const cleanFileName = fileName.trim().replace(/^imagenes\//, '');
    return `${SUPABASE_URL}/storage/v1/object/public/imagenes/${cleanFileName}`;
  }

  async function cargarProductos() {
    try {
      const r = await fetch(`${apiBase}/productos`);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      productos = await r.json();
      renderizarCarrito();
    } catch (err) {
      lista.innerHTML = '<p class="empty-cart">Error cargando productos. Intente recargar.</p>';
      console.error(err);
    }
  }

  function guardarCarrito() {
    localStorage.setItem('carrito', JSON.stringify(carrito));
  }

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
  }

  function formatMoney(n) {
    try { return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(n); }
    catch(e){ return '$' + Number(n).toFixed(2); }
  }

  function renderizarCarrito() {
    lista.innerHTML = '';
    postActions.innerHTML = '';

    if (carrito.length === 0) {
      lista.innerHTML = '<div class="empty-cart">üõí<br><br>Tu carrito est√° vac√≠o</div>';
      btnMostrarFormulario.disabled = true;
      btnMostrarFormulario.style.opacity = "0.5";
      totalCarritoElem.textContent = '$0.00';
      ocultarFormulario();
      return;
    }
    
    btnMostrarFormulario.disabled = false;
    btnMostrarFormulario.style.opacity = "1";

    let total = 0;

    carrito.forEach((item, i) => {
      const p = productos.find(prod => prod.id == item.id);
      if (!p) return;

      const precioPublico = (Number(p.precio || 0) * 1.10);
      const subtotal = precioPublico * item.cantidad;
      total += subtotal;

      const div = document.createElement('div');
      div.className = 'producto-carrito';
      
      const img = document.createElement('img');
      img.alt = p.nombre;
      img.src = getImageUrl('placeholder.png');
      if (p.imagen) {
        const publicUrl = getImageUrl(p.imagen);
        if (publicUrl) {
          const realImg = new Image();
          realImg.src = publicUrl;
          realImg.onload = () => { img.src = publicUrl; };
        }
      }
      
      div.innerHTML = `
        <div class="producto-info">
          <h3>${p.nombre}</h3>
          <div class="precio-unit">${formatMoney(precioPublico)} c/u</div>
          <div class="subtotal">${formatMoney(subtotal)}</div>
        </div>
        
        <div class="controles-cantidad">
          <div class="stepper">
              <button class="btn-reducir">-</button>
              <span class="cantidad-display">${item.cantidad}</span>
              <button class="btn-aumentar">+</button>
          </div>
          <button class="btn-eliminar">Eliminar</button>
        </div>
      `;
      div.insertBefore(img, div.firstChild);

      const btnAumentar = div.querySelector('.btn-aumentar');
      const btnReducir = div.querySelector('.btn-reducir');
      const btnEliminar = div.querySelector('.btn-eliminar');

      btnAumentar.addEventListener('click', (e) => {
        e.stopPropagation();
        carrito[i].cantidad++;
        guardarCarrito();
        renderizarCarrito();
      });

      btnReducir.addEventListener('click', (e) => {
        e.stopPropagation();
        if (carrito[i].cantidad > 1) carrito[i].cantidad--;
        else carrito.splice(i, 1);
        guardarCarrito();
        renderizarCarrito();
      });

      btnEliminar.addEventListener('click', (e) => {
        e.stopPropagation();
        carrito.splice(i, 1);
        guardarCarrito();
        renderizarCarrito();
      });

      lista.appendChild(div);
    });

    totalCarritoElem.textContent = formatMoney(total);
  }

  // Modal formulario
  async function mostrarFormulario() {
    document.getElementById('negocio').value = '';
    document.getElementById('nombre').value = '';
    document.getElementById('apellido').value = '';
    document.getElementById('telefono').value = '';

    const { data: { session } } = await supabase.auth.getSession();
    if (session && session.user && session.user.user_metadata) {
      if(session.user.user_metadata.full_name) {
          document.getElementById('nombre').value = session.user.user_metadata.full_name;
      }
    }

    formOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function ocultarFormulario() {
    formOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }

  btnMostrarFormulario.addEventListener('click', mostrarFormulario);
  btnCerrarFormulario.addEventListener('click', ocultarFormulario);
  formOverlay.addEventListener('click', e => { if (e.target === formOverlay) ocultarFormulario(); });

  btnConfirmar.addEventListener('click', async () => {
      const negocioInput = document.getElementById('negocio').value.trim();
      const nombreInput = document.getElementById('nombre').value.trim();
      const apellidoInput = document.getElementById('apellido').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      
      if (!negocioInput || !nombreInput || !apellidoInput || !telefono) {
          alert('Por favor, completa todos los campos (Negocio, Nombre, Apellido, Tel√©fono).');
          return;
      }
      
      const nombre = capitalize(nombreInput);
      const apellido = capitalize(apellidoInput);
      const fullName = `${nombre} ${apellido}`.trim();
      
      btnConfirmar.disabled = true;
      btnConfirmar.textContent = 'Enviando...';
      
      const nuevosCarrito = [];
      let total = 0;
      const productosClon = productos.map(p => ({...p}));
      
      for (const item of carrito) {
          const producto = productosClon.find(p => p.id == item.id);
          if (!producto) continue;
          const precioConRecargo = Number(producto.precio) * 1.10;
          nuevosCarrito.push({
              ...item,
              precio: precioConRecargo
          });
          total += item.cantidad * precioConRecargo;
      }
      
      if (nuevosCarrito.length === 0) {
          alert('No hay productos disponibles.');
          btnConfirmar.disabled = false;
          btnConfirmar.textContent = 'Enviar Pedido';
          return;
      }
      
      const { data: { session } } = await supabase.auth.getSession();
      const userId = session ? session.user.id : null;

      try {
          const res = await fetch(`${apiBase}/Enviar-Peticion`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  nombre: fullName,
                  telefono: telefono,
                  items: nuevosCarrito,
                  total: total,
                  user_id: userId,
                  nombre_negocio: negocioInput
              })
          });
          
          if (!res.ok) {
              const txt = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
              throw new Error(txt.error || `HTTP ${res.status}`);
          }
          
          alert('¬°Pedido enviado con √©xito!');
          carrito = [];
          guardarCarrito();
          ocultarFormulario();
          renderizarCarrito();
          
          setTimeout(() => { 
              if(userId) window.location.href = 'mi-cuenta.html';
              else window.location.href = 'IndexEllos.html'; 
          }, 500);
          
      } catch (err) {
          console.error('Error enviando pedido:', err);
          alert(`Error al enviar: ${err.message}`);
      } finally {
          btnConfirmar.disabled = false;
          btnConfirmar.textContent = 'Enviar Pedido';
      }
  });

  (async function init(){
    await cargarProductos();
  })();
</script>
</body>
</html>

